<html>
  <body>
    <!--StartFragment-->
    <div style="color: #000000;background-color: #ffffff;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;">
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"cache.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"config.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"grep.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"object-store.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"userdiff.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"xdiff-interface.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"diff.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"diffcore.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"commit.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"quote.h"</span></div>
      <div><span style="color: #808080;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">"help.h"</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_load(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_is_binary(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> index_state *</span><span style="color: #808080;">istate</span><span style="color: #000000;">);</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> std_output(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *</span><span style="color: #808080;">buf</span><span style="color: #000000;">, </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> </span><span style="color: #808080;">size</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; fwrite(buf, size, 1, stdout);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt grep_defaults = {</span></div>
      <div><span style="color: #000000;">&#160; &#160; .relative = 1,</span></div>
      <div><span style="color: #000000;">&#160; &#160; .pathname = 1,</span></div>
      <div><span style="color: #000000;">&#160; &#160; .max_depth = -1,</span></div>
      <div><span style="color: #000000;">&#160; &#160; .pattern_type_option = GREP_PATTERN_TYPE_UNSPECIFIED,</span></div>
      <div><span style="color: #000000;">&#160; &#160; .colors = {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_CONTEXT] = </span><span style="color: #a31515;">""</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_FILENAME] = GIT_COLOR_MAGENTA,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_FUNCTION] = </span><span style="color: #a31515;">""</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_LINENO] = GIT_COLOR_GREEN,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_COLUMNNO] = GIT_COLOR_GREEN,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_MATCH_CONTEXT] = GIT_COLOR_BOLD_RED,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_MATCH_SELECTED] = GIT_COLOR_BOLD_RED,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_SELECTED] = </span><span style="color: #a31515;">""</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; [GREP_COLOR_SEP] = GIT_COLOR_CYAN,</span></div>
      <div><span style="color: #000000;">&#160; &#160; },</span></div>
      <div><span style="color: #000000;">&#160; &#160; .only_matching = 0,</span></div>
      <div><span style="color: #000000;">&#160; &#160; .color = -1,</span></div>
      <div><span style="color: #000000;">&#160; &#160; .output = std_output,</span></div>
      <div><span style="color: #000000;">};</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *color_grep_slots</span><span style="color: #0000ff;">[]</span><span style="color: #000000;"> = {</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_CONTEXT] &#160; &#160; &#160; &#160;= </span><span style="color: #a31515;">"context"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_FILENAME] &#160; &#160; &#160; = </span><span style="color: #a31515;">"filename"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_FUNCTION] &#160; &#160; &#160; = </span><span style="color: #a31515;">"function"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_LINENO] &#160; &#160; = </span><span style="color: #a31515;">"lineNumber"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_COLUMNNO] &#160; &#160; &#160; = </span><span style="color: #a31515;">"column"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_MATCH_CONTEXT] &#160;= </span><span style="color: #a31515;">"matchContext"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_MATCH_SELECTED] = </span><span style="color: #a31515;">"matchSelected"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_SELECTED] &#160; &#160; &#160; = </span><span style="color: #a31515;">"selected"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; [GREP_COLOR_SEP] &#160; &#160; &#160; &#160;= </span><span style="color: #a31515;">"separator"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">};</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> parse_pattern_type_arg(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">arg</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(arg, </span><span style="color: #a31515;">"default"</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> GREP_PATTERN_TYPE_UNSPECIFIED;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(arg, </span><span style="color: #a31515;">"basic"</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> GREP_PATTERN_TYPE_BRE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(arg, </span><span style="color: #a31515;">"extended"</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> GREP_PATTERN_TYPE_ERE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(arg, </span><span style="color: #a31515;">"fixed"</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> GREP_PATTERN_TYPE_FIXED;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(arg, </span><span style="color: #a31515;">"perl"</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> GREP_PATTERN_TYPE_PCRE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; die(</span><span style="color: #a31515;">"bad %s argument: %s"</span><span style="color: #000000;">, opt, arg);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #000000;">define_list_config_array_extra(color_grep_slots, {</span><span style="color: #a31515;">"match"</span><span style="color: #000000;">});</span></div>
      <br>
      <div><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160;* Read the configuration file once and store it in</span></div>
      <div><span style="color: #008000;">&#160;* the grep_defaults template.</span></div>
      <div><span style="color: #008000;">&#160;*/</span></div>
      <div><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_config(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">var</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">value</span><span style="color: #000000;">, </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *</span><span style="color: #808080;">cb</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *opt = &amp;grep_defaults;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *slot;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (userdiff_config(var, value) &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* The instance of grep_opt that we set up here is copied by</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* grep_init() to be used by each individual invocation.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* When populating a new field of this structure here, be</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* sure to think about ownership -- e.g., you might need to</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* override the shallow copy in grep_init() with a deep copy.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"grep.extendedregexp"</span><span style="color: #000000;">)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;extended_regexp_option = git_config_bool(var, value);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"grep.patterntype"</span><span style="color: #000000;">)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pattern_type_option = parse_pattern_type_arg(var, value);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"grep.linenumber"</span><span style="color: #000000;">)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;linenum = git_config_bool(var, value);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"grep.column"</span><span style="color: #000000;">)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;columnnum = git_config_bool(var, value);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"grep.fullname"</span><span style="color: #000000;">)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;relative = !git_config_bool(var, value);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"color.grep"</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;color = git_config_colorbool(var, value);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!strcmp(var, </span><span style="color: #a31515;">"color.grep.match"</span><span style="color: #000000;">)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (grep_config(</span><span style="color: #a31515;">"color.grep.matchcontext"</span><span style="color: #000000;">, value, cb) &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (grep_config(</span><span style="color: #a31515;">"color.grep.matchselected"</span><span style="color: #000000;">, value, cb) &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (skip_prefix(var, </span><span style="color: #a31515;">"color.grep."</span><span style="color: #000000;">, &amp;slot)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i = LOOKUP_CONFIG(color_grep_slots, slot);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *color;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (i &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; color = opt-&gt;colors[i];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!value)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> config_error_nonbool(var);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> color_parse(value, color);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160;* Initialize one instance of grep_opt and copy the</span></div>
      <div><span style="color: #008000;">&#160;* default values from the template we read the configuration</span></div>
      <div><span style="color: #008000;">&#160;* information in an earlier call to git_config(grep_config).</span></div>
      <div><span style="color: #008000;">&#160;*/</span></div>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_init(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> repository *</span><span style="color: #808080;">repo</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">prefix</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; *opt = grep_defaults;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;repo = repo;</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;prefix = prefix;</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;prefix_length = (prefix &amp;&amp; *prefix) ? strlen(prefix) : 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;pattern_tail = &amp;opt-&gt;pattern_list;</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;header_tail = &amp;opt-&gt;header_list;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_set_pattern_type_option(</span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_pattern_type </span><span style="color: #808080;">pattern_type</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* When committing to the pattern type by setting the relevant</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* fields in grep_opt it's generally not necessary to zero out</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* the fields we're not choosing, since they won't have been</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* set by anything. The extended_regexp_option field is the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* only exception to this.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* This is because in the process of parsing grep.patternType</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* &amp; grep.extendedRegexp we set opt-&gt;pattern_type_option and</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* opt-&gt;extended_regexp_option, respectively. We then</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* internally use opt-&gt;extended_regexp_option to see if we're</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* compiling an ERE. It must be unset if that's not actually</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* the case.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (pattern_type != GREP_PATTERN_TYPE_ERE &amp;&amp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;extended_regexp_option)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;extended_regexp_option = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (pattern_type) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_TYPE_UNSPECIFIED:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* fall through */</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_TYPE_BRE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_TYPE_ERE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;extended_regexp_option = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_TYPE_FIXED:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;fixed = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_TYPE_PCRE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pcre2 = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_commit_pattern_type(</span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_pattern_type </span><span style="color: #808080;">pattern_type</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (pattern_type != GREP_PATTERN_TYPE_UNSPECIFIED)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_set_pattern_type_option(pattern_type, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pattern_type_option != GREP_PATTERN_TYPE_UNSPECIFIED)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_set_pattern_type_option(opt-&gt;pattern_type_option, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;extended_regexp_option)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* This branch *must* happen after setting from the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* opt-&gt;pattern_type_option above, we don't want</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* grep.extendedRegexp to override grep.patternType!</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_set_pattern_type_option(GREP_PATTERN_TYPE_ERE, opt);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *create_grep_pat(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">pat</span><span style="color: #000000;">, </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> </span><span style="color: #808080;">patlen</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">origin</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">no</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_pat_token </span><span style="color: #808080;">t</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_header_field </span><span style="color: #808080;">field</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p = xcalloc(1, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(*p));</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;pattern = xmemdupz(pat, patlen);</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;patternlen = patlen;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;origin = origin;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;no = no;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;token = t;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;field = field;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> p;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> do_append_grep_pat(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat ***</span><span style="color: #808080;">tail</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; **tail = p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; *tail = &amp;p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;next = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;token) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN: </span><span style="color: #008000;">/* atom */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (;;) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *new_pat;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> len = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *cp = p-&gt;pattern + p-&gt;patternlen, *nl = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (++len &lt;= p-&gt;patternlen) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (*(--cp) == </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; nl = cp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!nl)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; new_pat = create_grep_pat(nl + 1, len - 1, p-&gt;origin,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; p-&gt;no, p-&gt;token, p-&gt;field);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; new_pat-&gt;next = p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p-&gt;next)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; *tail = &amp;new_pat-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;next = new_pat;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; *nl = </span><span style="color: #a31515;">'\0'</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen -= len;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> append_header_grep_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_header_field </span><span style="color: #808080;">field</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">pat</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p = create_grep_pat(pat, strlen(pat), </span><span style="color: #a31515;">"header"</span><span style="color: #000000;">, 0,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GREP_PATTERN_HEAD, field);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (field == GREP_HEADER_REFLOG)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;use_reflog_filter = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; do_append_grep_pat(&amp;opt-&gt;header_tail, p);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> append_grep_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">pat</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">origin</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">no</span><span style="color: #000000;">, </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_pat_token </span><span style="color: #808080;">t</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; append_grep_pat(opt, pat, strlen(pat), origin, no, t);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> append_grep_pat(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">pat</span><span style="color: #000000;">, </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> </span><span style="color: #808080;">patlen</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">origin</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">no</span><span style="color: #000000;">, </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_pat_token </span><span style="color: #808080;">t</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p = create_grep_pat(pat, patlen, origin, no, t, 0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; do_append_grep_pat(&amp;opt-&gt;pattern_tail, p);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *grep_opt_dup(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *pat;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *ret = xmalloc(</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt));</span></div>
      <div><span style="color: #000000;">&#160; &#160; *ret = *opt;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; ret-&gt;pattern_list = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; ret-&gt;pattern_tail = &amp;ret-&gt;pattern_list;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(pat = opt-&gt;pattern_list; pat != </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">; pat = pat-&gt;next)</span></div>
      <div><span style="color: #000000;">&#160; &#160; {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(pat-&gt;token == GREP_PATTERN_HEAD)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; append_header_grep_pattern(ret, pat-&gt;field,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;pat-&gt;pattern);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; append_grep_pat(ret, pat-&gt;pattern, pat-&gt;patternlen,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pat-&gt;origin, pat-&gt;no, pat-&gt;token);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ret;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> NORETURN </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> compile_regexp_failed(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">error</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> where[1024];</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;no)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; xsnprintf(where, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(where), </span><span style="color: #a31515;">"In '%s' at %d, "</span><span style="color: #000000;">, p-&gt;origin, p-&gt;no);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;origin)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; xsnprintf(where, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(where), </span><span style="color: #a31515;">"%s, "</span><span style="color: #000000;">, p-&gt;origin);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; where[0] = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; die(</span><span style="color: #a31515;">"%s'%s': %s"</span><span style="color: #000000;">, where, p-&gt;pattern, error);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> is_fixed(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">s</span><span style="color: #000000;">, </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> </span><span style="color: #808080;">len</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> i;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (i = 0; i &lt; len; i++) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (is_regex_special(s[i]))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #808080;">#ifdef</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">USE_LIBPCRE2</span></div>
      <div><span style="color: #808080;">#define</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">GREP_PCRE2_DEBUG_MALLOC</span><span style="color: #0000ff;"> </span><span style="color: #000000;">0</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *pcre2_malloc(PCRE2_SIZE </span><span style="color: #808080;">size</span><span style="color: #000000;">, MAYBE_UNUSED </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *</span><span style="color: #808080;">memory_data</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *pointer = malloc(size);</span></div>
      <div><span style="color: #808080;">#if</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">GREP_PCRE2_DEBUG_MALLOC</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> count = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; fprintf(stderr, </span><span style="color: #a31515;">"PCRE2:%p -&gt; #%02d: alloc(%lu)\n"</span><span style="color: #000000;">, pointer, count++, size);</span></div>
      <div><span style="color: #808080;">#endif</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> pointer;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> pcre2_free(</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *</span><span style="color: #808080;">pointer</span><span style="color: #000000;">, MAYBE_UNUSED </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *</span><span style="color: #808080;">memory_data</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #808080;">#if</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">GREP_PCRE2_DEBUG_MALLOC</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> count = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (pointer)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; fprintf(stderr, </span><span style="color: #a31515;">"PCRE2:%p -&gt; #%02d: free()\n"</span><span style="color: #000000;">, pointer, count++);</span></div>
      <div><span style="color: #808080;">#endif</span></div>
      <div><span style="color: #000000;">&#160; &#160; free(pointer);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> compile_pcre2_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> error;</span></div>
      <div><span style="color: #000000;">&#160; &#160; PCRE2_UCHAR errbuf[256];</span></div>
      <div><span style="color: #000000;">&#160; &#160; PCRE2_SIZE erroffset;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> options = PCRE2_MULTILINE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> jitret;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> patinforet;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> jitsizearg;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> literal = !opt-&gt;ignore_case &amp;&amp; (p-&gt;fixed || p-&gt;is_fixed);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* Call pcre2_general_context_create() before calling any</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* other pcre2_*(). It sets up our malloc()/free() functions</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* with which everything else is allocated.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;pcre2_general_context = pcre2_general_context_create(</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pcre2_malloc, pcre2_free, </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p-&gt;pcre2_general_context)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"Couldn't allocate PCRE2 general context"</span><span style="color: #000000;">);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;ignore_case) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;ignore_locale &amp;&amp; has_non_ascii(p-&gt;pattern)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_tables = pcre2_maketables(p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_compile_context = pcre2_compile_context_create(p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; pcre2_set_character_tables(p-&gt;pcre2_compile_context,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_tables);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; options |= PCRE2_CASELESS;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;ignore_locale &amp;&amp; is_utf8_locale() &amp;&amp; !literal)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; options |= (PCRE2_UTF | PCRE2_MATCH_INVALID_UTF);</span></div>
      <br>
      <div><span style="color: #808080;">#ifdef</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">GIT_PCRE2_VERSION_10_36_OR_HIGHER</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* Work around https://bugs.exim.org/show_bug.cgi?id=2642 fixed in 10.36 */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (PCRE2_MATCH_INVALID_UTF &amp;&amp; options &amp; (PCRE2_UTF | PCRE2_CASELESS))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; options |= PCRE2_NO_START_OPTIMIZE;</span></div>
      <div><span style="color: #808080;">#endif</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;pcre2_pattern = pcre2_compile((PCRE2_SPTR)p-&gt;pattern,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;p-&gt;patternlen, options, &amp;error, &amp;erroffset,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;p-&gt;pcre2_compile_context);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;pcre2_pattern) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; p-&gt;pcre2_match_data = pcre2_match_data_create_from_pattern(p-&gt;pcre2_pattern, p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p-&gt;pcre2_match_data)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"Couldn't allocate PCRE2 match data"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pcre2_get_error_message(error, errbuf, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(errbuf));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; compile_regexp_failed(p, (</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *)&amp;errbuf);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; pcre2_config(PCRE2_CONFIG_JIT, &amp;p-&gt;pcre2_jit_on);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;pcre2_jit_on) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; jitret = pcre2_jit_compile(p-&gt;pcre2_pattern, PCRE2_JIT_COMPLETE);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (jitret)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"Couldn't JIT the PCRE2 pattern '%s', got '%d'\n"</span><span style="color: #000000;">, p-&gt;pattern, jitret);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* The pcre2_config(PCRE2_CONFIG_JIT, ...) call just</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* tells us whether the library itself supports JIT,</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* but to see whether we're going to be actually using</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* JIT we need to extract PCRE2_INFO_JITSIZE from the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* pattern *after* we do pcre2_jit_compile() above.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* This is because if the pattern contains the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* (*NO_JIT) verb (see pcre2syntax(3))</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* pcre2_jit_compile() will exit early with 0. If we</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* then proceed to call pcre2_jit_match() further down</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* the line instead of pcre2_match() we'll either</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* segfault (pre PCRE 10.31) or run into a fatal error</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* (post PCRE2 10.31)</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; patinforet = pcre2_pattern_info(p-&gt;pcre2_pattern, PCRE2_INFO_JITSIZE, &amp;jitsizearg);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (patinforet)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"pcre2_pattern_info() failed: %d"</span><span style="color: #000000;">, patinforet);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (jitsizearg == 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_jit_on = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> pcre2match(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">line</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regmatch_t *</span><span style="color: #808080;">match</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> ret, flags = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; PCRE2_SIZE *ovector;</span></div>
      <div><span style="color: #000000;">&#160; &#160; PCRE2_UCHAR errbuf[256];</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (eflags &amp; REG_NOTBOL)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; flags |= PCRE2_NOTBOL;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;pcre2_jit_on)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; ret = pcre2_jit_match(p-&gt;pcre2_pattern, (</span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *)line,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol - line, 0, flags, p-&gt;pcre2_match_data,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; ret = pcre2_match(p-&gt;pcre2_pattern, (</span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *)line,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol - line, 0, flags, p-&gt;pcre2_match_data,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (ret &lt; 0 &amp;&amp; ret != PCRE2_ERROR_NOMATCH) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pcre2_get_error_message(ret, errbuf, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(errbuf));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"%s failed with error code %d: %s"</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; (p-&gt;pcre2_jit_on ? </span><span style="color: #a31515;">"pcre2_jit_match"</span><span style="color: #000000;"> : </span><span style="color: #a31515;">"pcre2_match"</span><span style="color: #000000;">), ret,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; errbuf);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (ret &gt; 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; ovector = pcre2_get_ovector_pointer(p-&gt;pcre2_match_data);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; ret = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; match-&gt;rm_so = (</span><span style="color: #0000ff;">int</span><span style="color: #000000;">)ovector[0];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; match-&gt;rm_eo = (</span><span style="color: #0000ff;">int</span><span style="color: #000000;">)ovector[1];</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ret;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> free_pcre2_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; pcre2_compile_context_free(p-&gt;pcre2_compile_context);</span></div>
      <div><span style="color: #000000;">&#160; &#160; pcre2_code_free(p-&gt;pcre2_pattern);</span></div>
      <div><span style="color: #000000;">&#160; &#160; pcre2_match_data_free(p-&gt;pcre2_match_data);</span></div>
      <div><span style="color: #808080;">#ifdef</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">GIT_PCRE2_VERSION_10_34_OR_HIGHER</span></div>
      <div><span style="color: #000000;">&#160; &#160; pcre2_maketables_free(p-&gt;pcre2_general_context, p-&gt;pcre2_tables);</span></div>
      <div><span style="color: #808080;">#else</span></div>
      <div><span style="color: #000000;">&#160; &#160; free((</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *)p-&gt;pcre2_tables);</span></div>
      <div><span style="color: #808080;">#endif</span></div>
      <div><span style="color: #000000;">&#160; &#160; pcre2_general_context_free(p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <div><span style="color: #808080;">#else</span><span style="color: #000000;"> </span><span style="color: #008000;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> compile_pcre2_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; die(</span><span style="color: #a31515;">"cannot use Perl-compatible regexes when not compiled with USE_LIBPCRE"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> pcre2match(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">line</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regmatch_t *</span><span style="color: #808080;">match</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> free_pcre2_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> compile_fixed_regexp(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> strbuf sb = STRBUF_INIT;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> err;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> regflags = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; basic_regex_quote_buf(&amp;sb, p-&gt;pattern);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;ignore_case)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regflags |= REG_ICASE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; err = regcomp(&amp;p-&gt;regexp, sb.buf, regflags);</span></div>
      <div><span style="color: #000000;">&#160; &#160; strbuf_release(&amp;sb);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (err) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> errbuf[1024];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regerror(err, &amp;p-&gt;regexp, errbuf, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(errbuf));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; compile_regexp_failed(p, errbuf);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <div><span style="color: #808080;">#endif</span><span style="color: #000000;"> </span><span style="color: #008000;">/* !USE_LIBPCRE2 */</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> compile_regexp(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> err;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> regflags = REG_NEWLINE;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;word_regexp = opt-&gt;word_regexp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;ignore_case = opt-&gt;ignore_case;</span></div>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;fixed = opt-&gt;fixed;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (memchr(p-&gt;pattern, 0, p-&gt;patternlen) &amp;&amp; !opt-&gt;pcre2)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; die(_(</span><span style="color: #a31515;">"given pattern contains NULL byte (via -f &lt;file&gt;). This is only supported with -P under PCRE v2"</span><span style="color: #000000;">));</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; p-&gt;is_fixed = is_fixed(p-&gt;pattern, p-&gt;patternlen);</span></div>
      <div><span style="color: #808080;">#ifdef</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">USE_LIBPCRE2</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p-&gt;fixed &amp;&amp; !p-&gt;is_fixed) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *no_jit = </span><span style="color: #a31515;">"(*NO_JIT)"</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> no_jit_len = strlen(no_jit);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (starts_with(p-&gt;pattern, no_jit) &amp;&amp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160;is_fixed(p-&gt;pattern + no_jit_len,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen - no_jit_len))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;p-&gt;is_fixed = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160;}</span></div>
      <div><span style="color: #808080;">#endif</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;fixed || p-&gt;is_fixed) {</span></div>
      <div><span style="color: #808080;">#ifdef</span><span style="color: #0000ff;"> </span><span style="color: #bd63c5;">USE_LIBPCRE2</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;is_fixed) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; compile_pcre2_pattern(p, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* E.g. t7811-grep-open.sh relies on the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* pattern being restored.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *old_pattern = p-&gt;pattern;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> old_patternlen = p-&gt;patternlen;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> strbuf sb = STRBUF_INIT;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* There is the PCRE2_LITERAL flag, but it's</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* only in PCRE v2 10.30 and later. Needing to</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* ifdef our way around that and dealing with</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* it + PCRE2_MULTILINE being an error is more</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* complex than just quoting this ourselves.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; strbuf_add(&amp;sb, </span><span style="color: #a31515;">"\\Q"</span><span style="color: #000000;">, 2);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; strbuf_add(&amp;sb, p-&gt;pattern, p-&gt;patternlen);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; strbuf_add(&amp;sb, </span><span style="color: #a31515;">"\\E"</span><span style="color: #000000;">, 2);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pattern = sb.buf;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen = sb.len;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; compile_pcre2_pattern(p, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pattern = old_pattern;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen = old_patternlen;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; strbuf_release(&amp;sb);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #808080;">#else</span><span style="color: #000000;"> </span><span style="color: #008000;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; compile_fixed_regexp(p, opt);</span></div>
      <div><span style="color: #808080;">#endif</span><span style="color: #000000;"> </span><span style="color: #008000;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pcre2) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; compile_pcre2_pattern(p, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;ignore_case)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regflags |= REG_ICASE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;extended_regexp_option)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regflags |= REG_EXTENDED;</span></div>
      <div><span style="color: #000000;">&#160; &#160; err = regcomp(&amp;p-&gt;regexp, p-&gt;pattern, regflags);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (err) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> errbuf[1024];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regerror(err, &amp;p-&gt;regexp, errbuf, 1024);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; compile_regexp_failed(p, errbuf);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *grep_not_expr(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">expr</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *z = xcalloc(1, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(*z));</span></div>
      <div><span style="color: #000000;">&#160; &#160; z-&gt;node = GREP_NODE_NOT;</span></div>
      <div><span style="color: #000000;">&#160; &#160; z-&gt;u.unary = expr;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> z;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *grep_binexp(</span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_expr_node </span><span style="color: #808080;">kind</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">left</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">right</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *z = xcalloc(1, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(*z));</span></div>
      <div><span style="color: #000000;">&#160; &#160; z-&gt;node = kind;</span></div>
      <div><span style="color: #000000;">&#160; &#160; z-&gt;u.binary.left = left;</span></div>
      <div><span style="color: #000000;">&#160; &#160; z-&gt;u.binary.right = right;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> z;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *grep_or_expr(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">left</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">right</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_binexp(GREP_NODE_OR, left, right);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *grep_and_expr(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">left</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">right</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_binexp(GREP_NODE_AND, left, right);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *compile_pattern_or(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat **);</span></div>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *compile_pattern_atom(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat **</span><span style="color: #808080;">list</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *x;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;token) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN: </span><span style="color: #008000;">/* atom */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; CALLOC_ARRAY(x, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x-&gt;node = GREP_NODE_ATOM;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x-&gt;u.atom = p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *list = p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> x;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_OPEN_PAREN:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *list = p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x = compile_pattern_or(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!*list || (*list)-&gt;token != GREP_CLOSE_PAREN)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"unmatched parenthesis"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *list = (*list)-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> x;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *compile_pattern_not(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat **</span><span style="color: #808080;">list</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *x;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;token) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NOT:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p-&gt;next)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"--not not followed by pattern expression"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *list = p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x = compile_pattern_not(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!x)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"--not followed by non pattern expression"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_not_expr(x);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> compile_pattern_atom(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *compile_pattern_and(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat **</span><span style="color: #808080;">list</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *x, *y;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; x = compile_pattern_not(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p &amp;&amp; p-&gt;token == GREP_AND) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!x)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"--and not preceded by pattern expression"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!p-&gt;next)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"--and not followed by pattern expression"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *list = p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; y = compile_pattern_and(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!y)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"--and not followed by pattern expression"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_and_expr(x, y);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> x;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *compile_pattern_or(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat **</span><span style="color: #808080;">list</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *x, *y;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; x = compile_pattern_and(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (x &amp;&amp; p &amp;&amp; p-&gt;token != GREP_CLOSE_PAREN) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; y = compile_pattern_or(list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!y)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"not a pattern expression %s"</span><span style="color: #000000;">, p-&gt;pattern);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_or_expr(x, y);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> x;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *compile_pattern_expr(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat **</span><span style="color: #808080;">list</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> compile_pattern_or(list);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *grep_true_expr(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *z = xcalloc(1, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(*z));</span></div>
      <div><span style="color: #000000;">&#160; &#160; z-&gt;node = GREP_NODE_TRUE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> z;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *prep_header_patterns(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *header_expr;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *(header_group[GREP_HEADER_FIELD_MAX]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_header_field fld;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;header_list)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;header_list; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;token != GREP_PATTERN_HEAD)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"a non-header pattern in grep header list."</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;field &lt; GREP_HEADER_FIELD_MIN ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; GREP_HEADER_FIELD_MAX &lt;= p-&gt;field)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"unknown header field %d"</span><span style="color: #000000;">, p-&gt;field);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; compile_regexp(p, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (fld = 0; fld &lt; GREP_HEADER_FIELD_MAX; fld++)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; header_group[fld] = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;header_list; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *h;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *pp = p;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; h = compile_pattern_atom(&amp;pp);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!h || pp != p-&gt;next)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"malformed header expr"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!header_group[p-&gt;field]) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; header_group[p-&gt;field] = h;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; header_group[p-&gt;field] = grep_or_expr(h, header_group[p-&gt;field]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; header_expr = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (fld = 0; fld &lt; GREP_HEADER_FIELD_MAX; fld++) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!header_group[fld])</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!header_expr)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; header_expr = grep_true_expr();</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; header_expr = grep_or_expr(header_group[fld], header_expr);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> header_expr;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *grep_splice_or(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">x</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">y</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *z = x;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (x) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; assert(x-&gt;node == GREP_NODE_OR);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (x-&gt;u.binary.right &amp;&amp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; x-&gt;u.binary.right-&gt;node == GREP_NODE_TRUE) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; x-&gt;u.binary.right = y;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x = x-&gt;u.binary.right;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> z;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> compile_grep_patterns(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *header_expr = prep_header_patterns(opt);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;pattern_list; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;token) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN: </span><span style="color: #008000;">/* atom */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; compile_regexp(p, opt);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;extended = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;all_match || opt-&gt;no_body_match || header_expr)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;extended = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;extended)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; p = opt-&gt;pattern_list;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pattern_expression = compile_pattern_expr(&amp;p);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"incomplete pattern expression: %s"</span><span style="color: #000000;">, p-&gt;pattern);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;no_body_match &amp;&amp; opt-&gt;pattern_expression)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pattern_expression = grep_not_expr(opt-&gt;pattern_expression);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!header_expr)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;pattern_expression)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pattern_expression = header_expr;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;all_match)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pattern_expression = grep_splice_or(header_expr,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;opt-&gt;pattern_expression);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;pattern_expression = grep_or_expr(opt-&gt;pattern_expression,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;header_expr);</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;all_match = 1;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> free_pattern_expr(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">x</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (x-&gt;node) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_TRUE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_ATOM:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_NOT:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; free_pattern_expr(x-&gt;u.unary);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_AND:</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_OR:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; free_pattern_expr(x-&gt;u.binary.left);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; free_pattern_expr(x-&gt;u.binary.right);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; free(x);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> free_grep_patterns(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p, *n;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;pattern_list; p; p = n) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; n = p-&gt;next;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;token) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN: </span><span style="color: #008000;">/* atom */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;pcre2_pattern)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; free_pcre2_pattern(p);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; regfree(&amp;p-&gt;</span><span style="color: #808080;">regexp</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; free(p-&gt;</span><span style="color: #808080;">pattern</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; free(p);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;extended)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; free_pattern_expr(opt-&gt;pattern_expression);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *end_of_line(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">cp</span><span style="color: #000000;">, </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> *</span><span style="color: #808080;">left</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> l = *left;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (l &amp;&amp; *cp != </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; l--;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; cp++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; *left = l;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> cp;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> word_char(</span><span style="color: #0000ff;">char</span><span style="color: #000000;"> </span><span style="color: #808080;">ch</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> isalnum(ch) || ch == </span><span style="color: #a31515;">'_'</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> output_color(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> *</span><span style="color: #808080;">data</span><span style="color: #000000;">, </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> </span><span style="color: #808080;">size</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">color</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (want_color(opt-&gt;color) &amp;&amp; color &amp;&amp; color[0]) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, color, strlen(color));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, data, size);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, GIT_COLOR_RESET, strlen(GIT_COLOR_RESET));</span></div>
      <div><span style="color: #000000;">&#160; &#160; } </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, data, size);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> output_sep(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> </span><span style="color: #808080;">sign</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;null_following_name)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\0"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_color(opt, &amp;sign, 1, opt-&gt;colors[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> show_name(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">name</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; output_color(opt, name, strlen(name), opt-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;output(opt, opt-&gt;null_following_name ? </span><span style="color: #a31515;">"\0"</span><span style="color: #000000;"> : </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> patmatch(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">line</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; regmatch_t *</span><span style="color: #808080;">match</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> hit;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;pcre2_pattern)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; hit = !pcre2match(p, line, eol, match, eflags);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; hit = !regexec_buf(&amp;p-&gt;regexp, line, eol - line, 1, match,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;eflags);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> hit;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> strip_timestamp(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> **</span><span style="color: #808080;">eol_p</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *eol = *eol_p;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (bol &lt; --eol) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (*eol != </span><span style="color: #a31515;">'&gt;'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *eol_p = ++eol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *field;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> len;</span></div>
      <div><span style="color: #000000;">} header_field</span><span style="color: #0000ff;">[]</span><span style="color: #000000;"> = {</span></div>
      <div><span style="color: #000000;">&#160; &#160; { </span><span style="color: #a31515;">"author "</span><span style="color: #000000;">, 7 },</span></div>
      <div><span style="color: #000000;">&#160; &#160; { </span><span style="color: #a31515;">"committer "</span><span style="color: #000000;">, 10 },</span></div>
      <div><span style="color: #000000;">&#160; &#160; { </span><span style="color: #a31515;">"reflog "</span><span style="color: #000000;">, 7 },</span></div>
      <div><span style="color: #000000;">};</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> headerless_match_one_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; regmatch_t *</span><span style="color: #808080;">pmatch</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> hit = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *start = bol;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ((p-&gt;token != GREP_PATTERN) &amp;&amp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; ((p-&gt;token == GREP_PATTERN_HEAD) != (ctx == GREP_CONTEXT_HEAD)))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160;again:</span></div>
      <div><span style="color: #000000;">&#160; &#160; hit = patmatch(p, bol, eol, pmatch, eflags);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (hit &amp;&amp; p-&gt;word_regexp) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ((pmatch[0].rm_so &lt; 0) ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; (eol - bol) &lt; pmatch[0].rm_so ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; (pmatch[0].rm_eo &lt; 0) ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; (eol - bol) &lt; pmatch[0].rm_eo)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"regexp returned nonsense"</span><span style="color: #000000;">);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* Match beginning must be either beginning of the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* line, or at word boundary (i.e. the last char must</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* not be a word char). &#160;Similarly, match end must be</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* either end of the line, or at word boundary</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* (i.e. the next char must not be a word char).</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ( ((pmatch[0].rm_so == 0) ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; !word_char(bol[pmatch[0].rm_so-1])) &amp;&amp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;((pmatch[0].rm_eo == (eol-bol)) ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; !word_char(bol[pmatch[0].rm_eo])) )</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; ;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; hit = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* Words consist of at least one character. */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (pmatch-&gt;rm_so == pmatch-&gt;rm_eo)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; hit = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!hit &amp;&amp; pmatch[0].rm_so + bol + 1 &lt; eol) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* There could be more than one match on the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* line, and the first match might not be</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* strict word match. &#160;But later ones could be!</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Forward to the next possible start, i.e. the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* next position following a non-word char.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; bol = pmatch[0].rm_so + bol + 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (word_char(bol[-1]) &amp;&amp; bol &lt; eol)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; bol++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; eflags |= REG_NOTBOL;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bol &lt; eol)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">goto</span><span style="color: #000000;"> again;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (hit) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pmatch[0].rm_so += bol - start;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pmatch[0].rm_eo += bol - start;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> hit;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> match_one_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">, regmatch_t *</span><span style="color: #808080;">pmatch</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *field;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> len;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;token == GREP_PATTERN_HEAD) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; assert(p-&gt;field &lt; ARRAY_SIZE(header_field));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; field = header_field[p-&gt;field].field;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; len = header_field[p-&gt;field].len;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (strncmp(bol, field, len))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; bol += len;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;field) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_HEADER_AUTHOR:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_HEADER_COMMITTER:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; strip_timestamp(bol, &amp;</span><span style="color: #808080;">eol</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> headerless_match_one_pattern(p, bol, eol, ctx, pmatch, eflags);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> match_expr_eval(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">x</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">, </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> *</span><span style="color: #808080;">col</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> *</span><span style="color: #808080;">icol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">collect_hits</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> h = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!x)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"Not a valid grep expression"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (x-&gt;node) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_TRUE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; h = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_ATOM:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; regmatch_t tmp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; h = match_one_pattern(x-&gt;u.atom, bol, eol, ctx,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &amp;tmp, 0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (h &amp;&amp; (*col &lt; 0 || tmp.rm_so &lt; *col))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; *col = tmp.rm_so;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (x-&gt;u.atom-&gt;token == GREP_PATTERN_BODY)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;body_hit |= h;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_NOT:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* Upon visiting a GREP_NODE_NOT, col and icol become swapped.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; h = !match_expr_eval(opt, x-&gt;u.unary, bol, eol, ctx, icol, col,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_AND:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; h = match_expr_eval(opt, x-&gt;u.binary.left, bol, eol, ctx, col,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; icol, 0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (h || opt-&gt;columnnum) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Don't short-circuit AND when given --column, since a</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* NOT earlier in the tree may turn this into an OR. In</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* this case, see the below comment.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; h &amp;= match_expr_eval(opt, x-&gt;u.binary.right, bol, eol,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ctx, col, icol, 0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_NODE_OR:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!(collect_hits || opt-&gt;columnnum)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Don't short-circuit OR when given --column (or</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* collecting hits) to ensure we don't skip a later</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* child that would produce an earlier match.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> (match_expr_eval(opt, x-&gt;u.binary.left, bol, eol,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ctx, col, icol, 0) ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; match_expr_eval(opt, x-&gt;u.binary.right, bol,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol, ctx, col, icol, 0));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; h = match_expr_eval(opt, x-&gt;u.binary.left, bol, eol, ctx, col,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; icol, 0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (collect_hits)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; x-&gt;u.binary.left-&gt;hit |= h;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; h |= match_expr_eval(opt, x-&gt;u.binary.right, bol, eol, ctx, col,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;icol, collect_hits);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; die(</span><span style="color: #a31515;">"Unexpected node type (internal error) %d"</span><span style="color: #000000;">, x-&gt;</span><span style="color: #808080;">node</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (collect_hits)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x-&gt;hit |= h;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> h;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> match_expr(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">, </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> *</span><span style="color: #808080;">col</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> *</span><span style="color: #808080;">icol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">collect_hits</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *x = opt-&gt;pattern_expression;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> match_expr_eval(opt, x, bol, eol, ctx, col, icol, collect_hits);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> match_line(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> *</span><span style="color: #808080;">col</span><span style="color: #000000;">, </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> *</span><span style="color: #808080;">icol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">collect_hits</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> hit = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;extended)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> match_expr(opt, bol, eol, ctx, col, icol,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; collect_hits);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* we do not call with collect_hits without being extended */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;pattern_list; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regmatch_t tmp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match_one_pattern(p, bol, eol, ctx, &amp;tmp, 0)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; hit |= 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;columnnum) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* Without --column, any single match on a line</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* is enough to know that it needs to be</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* printed. With --column, scan _all_ patterns</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* to find the earliest.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (*col &lt; 0 || tmp.rm_so &lt; *col)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; *col = tmp.rm_so;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> hit;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> match_next_pattern(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *</span><span style="color: #808080;">p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; regmatch_t *</span><span style="color: #808080;">pmatch</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; regmatch_t match;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!headerless_match_one_pattern(p, bol, eol, ctx, &amp;match, eflags))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match.rm_so &lt; 0 || match.rm_eo &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (pmatch-&gt;rm_so &gt;= 0 &amp;&amp; pmatch-&gt;rm_eo &gt;= 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match.rm_so &gt; pmatch-&gt;rm_so)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match.rm_so == pmatch-&gt;rm_so &amp;&amp; match.rm_eo &lt; pmatch-&gt;rm_eo)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; pmatch-&gt;rm_so = match.rm_so;</span></div>
      <div><span style="color: #000000;">&#160; &#160; pmatch-&gt;rm_eo = match.rm_eo;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_next_match(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context </span><span style="color: #808080;">ctx</span><span style="color: #000000;">, regmatch_t *</span><span style="color: #808080;">pmatch</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_header_field </span><span style="color: #808080;">field</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">eflags</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> hit = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; pmatch-&gt;rm_so = pmatch-&gt;rm_eo = -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bol &lt; eol) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = ((ctx == GREP_CONTEXT_HEAD)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;? opt-&gt;header_list : opt-&gt;pattern_list);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (p-&gt;token) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ((field != GREP_HEADER_FIELD_MAX) &amp;&amp;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (p-&gt;field != field))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* fall thru */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN: </span><span style="color: #008000;">/* atom */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; hit |= match_next_pattern(p, bol, eol, ctx,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pmatch, eflags);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> hit;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> show_line_header(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">name</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #808080;">lno</span><span style="color: #000000;">, </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> </span><span style="color: #808080;">cno</span><span style="color: #000000;">, </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> </span><span style="color: #808080;">sign</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;heading &amp;&amp; opt-&gt;last_shown == 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_color(opt, name, strlen(name), opt-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;last_shown = lno;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;heading &amp;&amp; opt-&gt;pathname) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_color(opt, name, strlen(name), opt-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_sep(opt, sign);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;linenum) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> buf[32];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; xsnprintf(buf, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(buf), </span><span style="color: #a31515;">"%d"</span><span style="color: #000000;">, lno);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_color(opt, buf, strlen(buf), opt-&gt;colors[GREP_COLOR_LINENO]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_sep(opt, sign);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* Treat 'cno' as the 1-indexed offset from the start of a non-context</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* line to its first match. Otherwise, 'cno' is 0 indicating that we are</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* being called with a context line.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;columnnum &amp;&amp; cno) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> buf[32];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; xsnprintf(buf, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(buf), </span><span style="color: #a31515;">"%"</span><span style="color: #000000;">PRIuMAX, (</span><span style="color: #0000ff;">uintmax_t</span><span style="color: #000000;">)cno);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_color(opt, buf, strlen(buf), opt-&gt;colors[GREP_COLOR_COLUMNNO]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_sep(opt, sign);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> show_line(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">name</span><span style="color: #000000;">, </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #808080;">lno</span><span style="color: #000000;">, </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> </span><span style="color: #808080;">cno</span><span style="color: #000000;">, </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> </span><span style="color: #808080;">sign</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> rest = eol - bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *match_color = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *line_color = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;file_break &amp;&amp; opt-&gt;last_shown == 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;show_hunk_mark)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pre_context || opt-&gt;post_context || opt-&gt;funcbody) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;last_shown == 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;show_hunk_mark) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; output_color(opt, </span><span style="color: #a31515;">"--"</span><span style="color: #000000;">, 2, opt-&gt;colors[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (lno &gt; opt-&gt;last_shown + 1) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; output_color(opt, </span><span style="color: #a31515;">"--"</span><span style="color: #000000;">, 2, opt-&gt;colors[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;only_matching) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* In case the line we're being called with contains more than</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* one match, leave printing each header to the loop below.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; show_line_header(opt, name, lno, cno, sign);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;color || opt-&gt;only_matching) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regmatch_t match;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context ctx = GREP_CONTEXT_BODY;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> eflags = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;color) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (sign == </span><span style="color: #a31515;">':'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; match_color = opt-&gt;colors[GREP_COLOR_MATCH_SELECTED];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; match_color = opt-&gt;colors[GREP_COLOR_MATCH_CONTEXT];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (sign == </span><span style="color: #a31515;">':'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; line_color = opt-&gt;colors[GREP_COLOR_SELECTED];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (sign == </span><span style="color: #a31515;">'-'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; line_color = opt-&gt;colors[GREP_COLOR_CONTEXT];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (sign == </span><span style="color: #a31515;">'='</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; line_color = opt-&gt;colors[GREP_COLOR_FUNCTION];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (grep_next_match(opt, bol, eol, ctx, &amp;match,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GREP_HEADER_FIELD_MAX, eflags)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match.rm_so == match.rm_eo)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;only_matching)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_line_header(opt, name, lno, cno, sign);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; output_color(opt, bol, match.rm_so, line_color);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; output_color(opt, bol + match.rm_so,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;match.rm_eo - match.rm_so, match_color);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;only_matching)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; bol += match.rm_eo;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; cno += match.rm_eo;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; rest -= match.rm_eo;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; eflags = REG_NOTBOL;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;only_matching) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; output_color(opt, bol, rest, line_color);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">, 1);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_use_locks;</span></div>
      <br>
      <div><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160;* This lock protects access to the gitattributes machinery, which is</span></div>
      <div><span style="color: #008000;">&#160;* not thread-safe.</span></div>
      <div><span style="color: #008000;">&#160;*/</span></div>
      <div><span style="color: #0000ff;">pthread_mutex_t</span><span style="color: #000000;"> grep_attr_mutex;</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">inline</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_attr_lock(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (grep_use_locks)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pthread_mutex_lock(&amp;grep_attr_mutex);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">inline</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_attr_unlock(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (grep_use_locks)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; pthread_mutex_unlock(&amp;grep_attr_mutex);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> match_funcname(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; xdemitconf_t *xecfg = opt-&gt;priv;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (xecfg &amp;&amp; !xecfg-&gt;find_func) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_source_load_driver(gs, opt-&gt;repo-&gt;index);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (gs-&gt;driver-&gt;funcname.pattern) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> userdiff_funcname *pe = &amp;gs-&gt;driver-&gt;funcname;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; xdiff_set_find_func(xecfg, pe-&gt;pattern, pe-&gt;cflags);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; xecfg = opt-&gt;priv = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (xecfg) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> buf[1];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> xecfg-&gt;find_func(bol, eol - bol, buf, 1,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; xecfg-&gt;find_func_priv) &gt;= 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bol == eol)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isalpha(*bol) || *bol == </span><span style="color: #a31515;">'_'</span><span style="color: #000000;"> || *bol == </span><span style="color: #a31515;">'$'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> show_funcname_line(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #808080;">lno</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (bol &gt; gs-&gt;buf) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *eol = --bol;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (bol &gt; gs-&gt;buf &amp;&amp; bol[-1] != </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; bol--;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; lno--;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (lno &lt;= opt-&gt;last_shown)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match_funcname(opt, gs, bol, eol)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; show_line(opt, bol, eol, gs-&gt;name, lno, 0, </span><span style="color: #a31515;">'='</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> is_empty_line(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">);</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> show_pre_context(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">end</span><span style="color: #000000;">, </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #808080;">lno</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> cur = lno, from = 1, funcname_lno = 0, orig_from;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> funcname_needed = !!opt-&gt;funcname, comment_needed = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pre_context &lt; lno)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; from = lno - opt-&gt;pre_context;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (from &lt;= opt-&gt;last_shown)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; from = opt-&gt;last_shown + 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; orig_from = from;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;funcbody) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match_funcname(opt, gs, bol, end))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; comment_needed = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; funcname_needed = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; from = opt-&gt;last_shown + 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* Rewind. */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (bol &gt; gs-&gt;buf &amp;&amp; cur &gt; from) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *next_bol = bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *eol = --bol;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (bol &gt; gs-&gt;buf &amp;&amp; bol[-1] != </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; bol--;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; cur--;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (comment_needed &amp;&amp; (is_empty_line(bol, eol) ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;match_funcname(opt, gs, bol, eol))) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; comment_needed = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; from = orig_from;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (cur &lt; from) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; cur++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; bol = next_bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (funcname_needed &amp;&amp; match_funcname(opt, gs, bol, eol)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; funcname_lno = cur;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; funcname_needed = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;funcbody)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; comment_needed = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; from = orig_from;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* We need to look even further back to find a function signature. */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;funcname &amp;&amp; funcname_needed)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; show_funcname_line(opt, gs, bol, cur);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* Back forward. */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (cur &lt; lno) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *eol = bol, sign = (cur == funcname_lno) ? </span><span style="color: #a31515;">'='</span><span style="color: #000000;"> : </span><span style="color: #a31515;">'-'</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (*eol != </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; eol++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; show_line(opt, bol, eol, gs-&gt;name, cur, 0, sign);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; bol = eol + 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; cur++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> should_lookahead(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;extended)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0; </span><span style="color: #008000;">/* punt for too complex stuff */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;invert)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;pattern_list; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (p-&gt;token != GREP_PATTERN)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0; </span><span style="color: #008000;">/* punt for "header only" and stuff */</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> look_ahead(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> *</span><span style="color: #808080;">left_p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> *</span><span style="color: #808080;">lno_p</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> **</span><span style="color: #808080;">bol_p</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> lno = *lno_p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *bol = *bol_p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_pat *p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *sp, *last_bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; regoff_t earliest = -1;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (p = opt-&gt;pattern_list; p; p = p-&gt;next) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> hit;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; regmatch_t m;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; hit = patmatch(p, bol, bol + *left_p, &amp;m, 0);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!hit || m.rm_so &lt; 0 || m.rm_eo &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (earliest &lt; 0 || m.rm_so &lt; earliest)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; earliest = m.rm_so;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (earliest &lt; 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *bol_p = bol + *left_p;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; *left_p = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (sp = bol + earliest; bol &lt; sp &amp;&amp; sp[-1] != </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">; sp--)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; ; </span><span style="color: #008000;">/* find the beginning of the line */</span></div>
      <div><span style="color: #000000;">&#160; &#160; last_bol = sp;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (sp = bol; sp &lt; last_bol; sp++) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (*sp == </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; lno++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; *left_p -= last_bol - bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; *bol_p = last_bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; *lno_p = lno;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> fill_textconv_grep(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> repository *</span><span style="color: #808080;">r</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> userdiff_driver *</span><span style="color: #808080;">driver</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> diff_filespec *df;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *buf;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> size;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!driver || !driver-&gt;textconv)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_source_load(gs);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* The textconv interface is intimately tied to diff_filespecs, so we</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* have to pretend to be one. If we could unify the grep_source</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* and diff_filespec structs, this mess could just go away.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; df = alloc_filespec(gs-&gt;path);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (gs-&gt;type) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; fill_filespec(df, gs-&gt;</span><span style="color: #808080;">identifier</span><span style="color: #000000;">, 1, </span><span style="color: #09885a;">0</span><span style="color: #000000;">100644);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; fill_filespec(df, null_oid(), 0, </span><span style="color: #09885a;">0</span><span style="color: #000000;">100644);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"attempt to textconv something without a path?"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* fill_textconv is not remotely thread-safe; it modifies the global</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* diff tempfile structure, writes to the_repo's odb and might</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* internally call thread-unsafe functions such as the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* prepare_packed_git() lazy-initializator. Because of the last two, we</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* must ensure mutual exclusion between this call and the object reading</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* API, thus we use obj_read_lock() here.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* TODO: allowing text conversion to run in parallel with object</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* reading operations might increase performance in the multithreaded</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* non-worktreee git-grep with --textconv.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; obj_read_lock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; size = fill_textconv(r, driver, df, &amp;buf);</span></div>
      <div><span style="color: #000000;">&#160; &#160; obj_read_unlock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; free_filespec(df);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* The normal fill_textconv usage by the diff machinery would just keep</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* the textconv'd buf separate from the diff_filespec. But much of the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* grep code passes around a grep_source and assumes that its "buf"</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* pointer is the beginning of the thing we are searching. So let's</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* install our textconv'd version into the grep_source, taking care not</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* to leak any existing buffer.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; grep_source_clear_data(gs);</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;buf = buf;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;size = size;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> is_empty_line(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">bol</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">eol</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (bol &lt; eol &amp;&amp; isspace(*bol))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; bol++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> bol == eol;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_1(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> </span><span style="color: #808080;">collect_hits</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *peek_bol = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> left;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> lno = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> last_hit = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> binary_match_only = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> count = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> try_lookahead = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> show_function = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> userdiff_driver *textconv = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> grep_context ctx = GREP_CONTEXT_HEAD;</span></div>
      <div><span style="color: #000000;">&#160; &#160; xdemitconf_t xecfg;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;status_only &amp;&amp; gs-&gt;name == </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"grep call which could print a name requires "</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #a31515;">"grep_source.name be non-NULL"</span><span style="color: #000000;">);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;output)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output = std_output;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pre_context || opt-&gt;post_context || opt-&gt;file_break ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;funcbody) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* Show hunk marks, except for the first file. */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;last_shown)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;show_hunk_mark = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* If we're using threads then we can't easily identify</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* the first file. &#160;Always put hunk marks in that case</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* and skip the very first one later in work_done().</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;output != std_output)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;show_hunk_mark = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;last_shown = 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;allow_textconv) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_source_load_driver(gs, opt-&gt;repo-&gt;index);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* We might set up the shared textconv cache data here, which</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* is not thread-safe. Also, get_oid_with_context() and</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* parse_object() might be internally called. As they are not</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* currently thread-safe and might be racy with object reading,</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* obj_read_lock() must be called.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_attr_lock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; obj_read_lock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; textconv = userdiff_get_textconv(opt-&gt;repo, gs-&gt;driver);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; obj_read_unlock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; grep_attr_unlock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* We know the result of a textconv is text, so we only have to care</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* about binary handling if we are not using it.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!textconv) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (opt-&gt;binary) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_BINARY_DEFAULT:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (grep_source_is_binary(gs, opt-&gt;repo-&gt;</span><span style="color: #808080;">index</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; binary_match_only = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_BINARY_NOMATCH:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (grep_source_is_binary(gs, opt-&gt;repo-&gt;</span><span style="color: #808080;">index</span><span style="color: #000000;">))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0; </span><span style="color: #008000;">/* Assume unmatch */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_BINARY_TEXT:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; BUG(</span><span style="color: #a31515;">"unknown binary handling mode"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; memset(&amp;xecfg, 0, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(xecfg));</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;priv = &amp;xecfg;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; try_lookahead = should_lookahead(opt);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fill_textconv_grep(opt-&gt;repo, textconv, gs) &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; bol = gs-&gt;buf;</span></div>
      <div><span style="color: #000000;">&#160; &#160; left = gs-&gt;size;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (left) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *eol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> hit;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> cno;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">ssize_t</span><span style="color: #000000;"> col = -1, icol = -1;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* look_ahead() skips quickly to the line that possibly</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* has the next hit; don't call it if we need to do</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* something more than just skipping the current line</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* in response to an unmatch for the current line. &#160;E.g.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* inside a post-context window, we will show the current</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* line as a context around the previous hit when it</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* doesn't hit.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (try_lookahead</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &amp;&amp; !(last_hit</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;&amp;&amp; (show_function ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;lno &lt;= last_hit + opt-&gt;post_context))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &amp;&amp; look_ahead(opt, &amp;left, &amp;lno, &amp;bol))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; eol = end_of_line(bol, &amp;left);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ((ctx == GREP_CONTEXT_HEAD) &amp;&amp; (eol == bol))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; ctx = GREP_CONTEXT_BODY;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; hit = match_line(opt, bol, eol, &amp;col, &amp;icol, ctx, collect_hits);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (collect_hits)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">goto</span><span style="color: #000000;"> next_line;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* "grep -v -e foo -e bla" should list lines</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* that do not have either, so inversion should</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;* be done outside.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;invert)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; hit = !hit;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;unmatch_name_only) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (hit)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">goto</span><span style="color: #000000;"> next_line;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (hit) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; count++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;status_only)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;name_only) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_name(opt, gs-&gt;name);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;count)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">goto</span><span style="color: #000000;"> next_line;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (binary_match_only) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">"Binary file "</span><span style="color: #000000;">, 12);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; output_color(opt, gs-&gt;name, strlen(gs-&gt;name),</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;opt-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; opt-&gt;output(opt, </span><span style="color: #a31515;">" matches\n"</span><span style="color: #000000;">, 9);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* Hit at this line. &#160;If we haven't shown the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* pre-context lines, we would need to show them.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pre_context || opt-&gt;funcbody)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_pre_context(opt, gs, bol, eol, lno);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;funcname)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_funcname_line(opt, gs, bol, lno);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; cno = opt-&gt;invert ? icol : col;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (cno &lt; 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* A negative cno indicates that there was no</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* match on the line. We are thus inverted and</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* being asked to show all lines that _don't_</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* match a given expression. Therefore, set cno</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* to 0 to suggest the whole line matches.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; cno = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; show_line(opt, bol, eol, gs-&gt;name, lno, cno + 1, </span><span style="color: #a31515;">':'</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; last_hit = lno;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;funcbody)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_function = 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">goto</span><span style="color: #000000;"> next_line;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (show_function &amp;&amp; (!peek_bol || peek_bol &lt; bol)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> peek_left = left;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *peek_eol = eol;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Trailing empty lines are not interesting.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Peek past them to see if they belong to the</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* body of the current function.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; peek_bol = bol;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (is_empty_line(peek_bol, peek_eol)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; peek_bol = peek_eol + 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; peek_eol = end_of_line(peek_bol, &amp;peek_left);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (match_funcname(opt, gs, peek_bol, peek_eol))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_function = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (show_function ||</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; (last_hit &amp;&amp; lno &lt;= last_hit + opt-&gt;post_context)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* If the last hit is within the post context,</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* we need to show this line.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; show_line(opt, bol, eol, gs-&gt;name, lno, col + 1, </span><span style="color: #a31515;">'-'</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; next_line:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; bol = eol + 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!left)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; left--;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; lno++;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (collect_hits)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;status_only)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> opt-&gt;unmatch_name_only;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;unmatch_name_only) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* We did not see any hit, so we want to show this */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; show_name(opt, gs-&gt;name);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; xdiff_clear_find_func(&amp;xecfg);</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;priv = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* NEEDSWORK:</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* The real "grep -c foo *.c" gives many "bar.c:0" lines,</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* which feels mostly useless but sometimes useful. &#160;Maybe</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* make it another option? &#160;For now suppress them.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;count &amp;&amp; count) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> buf[32];</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;pathname) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; output_color(opt, gs-&gt;name, strlen(gs-&gt;name),</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;opt-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; output_sep(opt, </span><span style="color: #a31515;">':'</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; xsnprintf(buf, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(buf), </span><span style="color: #a31515;">"%u\n"</span><span style="color: #000000;">, count);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; opt-&gt;output(opt, buf, strlen(buf));</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> !!last_hit;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> clr_hit_marker(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">x</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* All-hit markers are meaningful only at the very top level</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* OR node.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (1) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x-&gt;hit = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (x-&gt;node != GREP_NODE_OR)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x-&gt;u.binary.left-&gt;hit = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x = x-&gt;u.binary.right;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> chk_hit_marker(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_expr *</span><span style="color: #808080;">x</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* Top level nodes have hit markers. &#160;See if they all are hits */</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (1) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (x-&gt;node != GREP_NODE_OR)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> x-&gt;hit;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!x-&gt;u.binary.left-&gt;hit)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; x = x-&gt;u.binary.right;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/*</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* we do not have to do the two-pass grep when we do not check</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* buffer-wide "all-match".</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!opt-&gt;all_match &amp;&amp; !opt-&gt;no_body_match)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_source_1(opt, gs, 0);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #008000;">/* Otherwise the toplevel "or" terms hit a bit differently.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;* We first clear hit markers from them.</span></div>
      <div><span style="color: #008000;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #000000;">&#160; &#160; clr_hit_marker(opt-&gt;pattern_expression);</span></div>
      <div><span style="color: #000000;">&#160; &#160; opt-&gt;body_hit = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; grep_source_1(opt, gs, 1);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;all_match &amp;&amp; !chk_hit_marker(opt-&gt;pattern_expression))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (opt-&gt;no_body_match &amp;&amp; opt-&gt;body_hit)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_source_1(opt, gs, 0);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_source_init_buf(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">buf</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> </span><span style="color: #808080;">size</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;type = GREP_SOURCE_BUF;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;name = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;path = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;buf = buf;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;size = size;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;driver = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;identifier = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_buffer(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_opt *</span><span style="color: #808080;">opt</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">buf</span><span style="color: #000000;">, </span><span style="color: #0000ff;">unsigned</span><span style="color: #000000;"> </span><span style="color: #0000ff;">long</span><span style="color: #000000;"> </span><span style="color: #808080;">size</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source gs;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> r;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; grep_source_init_buf(&amp;gs, buf, size);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; r = grep_source(opt, &amp;gs);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; grep_source_clear(&amp;gs);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> r;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_source_init_file(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">name</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">path</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;type = GREP_SOURCE_FILE;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;name = xstrdup_or_null(name);</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;path = xstrdup_or_null(path);</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;buf = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;size = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;driver = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;identifier = xstrdup(path);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_source_init_oid(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">name</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *</span><span style="color: #808080;">path</span><span style="color: #000000;">, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> object_id *</span><span style="color: #808080;">oid</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> repository *</span><span style="color: #808080;">repo</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;type = GREP_SOURCE_OID;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;name = xstrdup_or_null(name);</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;path = xstrdup_or_null(path);</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;buf = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;size = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;driver = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;identifier = oiddup(oid);</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;repo = repo;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_source_clear(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; FREE_AND_NULL(gs-&gt;name);</span></div>
      <div><span style="color: #000000;">&#160; &#160; FREE_AND_NULL(gs-&gt;path);</span></div>
      <div><span style="color: #000000;">&#160; &#160; FREE_AND_NULL(gs-&gt;identifier);</span></div>
      <div><span style="color: #000000;">&#160; &#160; grep_source_clear_data(gs);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_source_clear_data(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (gs-&gt;type) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* these types own the buffer */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; free((</span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *)gs-&gt;</span><span style="color: #808080;">buf</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; gs-&gt;buf = </span><span style="color: #0000ff;">NULL</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; gs-&gt;size = 0;</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_BUF:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #008000;">/* leave user-provided buf intact */</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_load_oid(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> object_type type;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;buf = repo_read_object_file(gs-&gt;repo, gs-&gt;identifier, &amp;type,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &amp;gs-&gt;size);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!gs-&gt;buf)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> error(_(</span><span style="color: #a31515;">"'%s': unable to read %s"</span><span style="color: #000000;">),</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;gs-&gt;name,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;oid_to_hex(gs-&gt;identifier));</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_load_file(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *filename = gs-&gt;identifier;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> stat st;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> *data;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">size_t</span><span style="color: #000000;"> size;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (lstat(filename, &amp;st) &lt; 0) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; err_ret:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (errno != ENOENT)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; error_errno(_(</span><span style="color: #a31515;">"failed to stat '%s'"</span><span style="color: #000000;">), filename);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!S_ISREG(st.st_mode))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; size = xsize_t(st.st_size);</span></div>
      <div><span style="color: #000000;">&#160; &#160; i = open(filename, O_RDONLY);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (i &lt; 0)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">goto</span><span style="color: #000000;"> err_ret;</span></div>
      <div><span style="color: #000000;">&#160; &#160; data = xmallocz(size);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (st.st_size != read_in_full(i, data, size)) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; error_errno(_(</span><span style="color: #a31515;">"'%s': short read"</span><span style="color: #000000;">), filename);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; close(i);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; free(data);</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; close(i);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;buf = data;</span></div>
      <div><span style="color: #000000;">&#160; &#160; gs-&gt;size = size;</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_load(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (gs-&gt;buf)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (gs-&gt;type) {</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_source_load_file(gs);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> grep_source_load_oid(gs);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> GREP_SOURCE_BUF:</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> gs-&gt;buf ? 0 : -1;</span></div>
      <div><span style="color: #000000;">&#160; &#160; }</span></div>
      <div><span style="color: #000000;">&#160; &#160; BUG(</span><span style="color: #a31515;">"invalid grep_source type to load"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">void</span><span style="color: #000000;"> grep_source_load_driver(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> index_state *</span><span style="color: #808080;">istate</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (gs-&gt;driver)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; grep_attr_lock();</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (gs-&gt;path)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; gs-&gt;driver = userdiff_find_by_path(istate, gs-&gt;path);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!gs-&gt;driver)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; gs-&gt;driver = userdiff_find_by_name(</span><span style="color: #a31515;">"default"</span><span style="color: #000000;">);</span></div>
      <div><span style="color: #000000;">&#160; &#160; grep_attr_unlock();</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
      <div><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> grep_source_is_binary(</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> grep_source *</span><span style="color: #808080;">gs</span><span style="color: #000000;">,</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> index_state *</span><span style="color: #808080;">istate</span><span style="color: #000000;">)</span></div>
      <div><span style="color: #000000;">{</span></div>
      <div><span style="color: #000000;">&#160; &#160; grep_source_load_driver(gs, istate);</span></div>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (gs-&gt;driver-&gt;binary != -1)</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> gs-&gt;driver-&gt;binary;</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!grep_source_load(gs))</span></div>
      <div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> buffer_is_binary(gs-&gt;buf, gs-&gt;size);</span></div>
      <br>
      <div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0;</span></div>
      <div><span style="color: #000000;">}</span></div>
      <br>
    </div>
    <!--EndFragment-->
  </body>
</html>
