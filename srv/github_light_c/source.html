<html>
  <body>
    <!--StartFragment-->
    <div style="color: #24292f;background-color: #ffffff;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;">
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"cache.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"config.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"grep.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"object-store.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"userdiff.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"xdiff-interface.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"diff.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"diffcore.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"commit.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"quote.h"</span></div>
      <div><span style="color: #cf222e;">#include</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"help.h"</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_is_binary</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">index_state</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">istate</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">std_output</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">buf</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">size</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">fwrite</span><span style="color: #24292f;">(</span><span style="color: #953800;">buf</span><span style="color: #24292f;">, </span><span style="color: #953800;">size</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, stdout);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #24292f;">grep_defaults</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .relative </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .pathname </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .max_depth </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .pattern_type_option </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_UNSPECIFIED,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .colors </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_CONTEXT] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">""</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_FILENAME] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GIT_COLOR_MAGENTA,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_FUNCTION] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">""</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_LINENO] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GIT_COLOR_GREEN,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_COLUMNNO] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GIT_COLOR_GREEN,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_MATCH_CONTEXT] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GIT_COLOR_BOLD_RED,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_MATCH_SELECTED] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GIT_COLOR_BOLD_RED,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_SELECTED] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">""</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; [GREP_COLOR_SEP] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GIT_COLOR_CYAN,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; },</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .only_matching </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .color </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; .output </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">std_output</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">};</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">color_grep_slots</span><span style="color: #cf222e;">[]</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_CONTEXT] &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"context"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_FILENAME] &#160; &#160; &#160; </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"filename"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_FUNCTION] &#160; &#160; &#160; </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"function"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_LINENO] &#160; &#160; </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"lineNumber"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_COLUMNNO] &#160; &#160; &#160; </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"column"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_MATCH_CONTEXT] &#160;</span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"matchContext"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_MATCH_SELECTED] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"matchSelected"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_SELECTED] &#160; &#160; &#160; </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"selected"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; [GREP_COLOR_SEP] &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"separator"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">};</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">parse_pattern_type_arg</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">arg</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">arg</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"default"</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_UNSPECIFIED;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">arg</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"basic"</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_BRE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">arg</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"extended"</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_ERE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">arg</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"fixed"</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_FIXED;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">arg</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"perl"</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_PCRE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"bad </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;"> argument: </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">arg</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #8250df;">define_list_config_array_extra</span><span style="color: #24292f;">(</span><span style="color: #953800;">color_grep_slots</span><span style="color: #24292f;">, {</span><span style="color: #0a3069;">"match"</span><span style="color: #24292f;">});</span></div>
      <br>
      <div><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160;* Read the configuration file once and store it in</span></div>
      <div><span style="color: #6e7781;">&#160;* the grep_defaults template.</span></div>
      <div><span style="color: #6e7781;">&#160;*/</span></div>
      <div><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_config</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">value</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">cb</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">grep_defaults</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">slot</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">userdiff_config</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* The instance of grep_opt that we set up here is copied by</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* grep_init() to be used by each individual invocation.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* When populating a new field of this structure here, be</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* sure to think about ownership -- e.g., you might need to</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* override the shallow copy in grep_init() with a deep copy.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"grep.extendedregexp"</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;extended_regexp_option </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">git_config_bool</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"grep.patterntype"</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;pattern_type_option </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">parse_pattern_type_arg</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"grep.linenumber"</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;linenum </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">git_config_bool</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"grep.column"</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;columnnum </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">git_config_bool</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"grep.fullname"</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;relative </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">git_config_bool</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"color.grep"</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;color </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">git_config_colorbool</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">strcmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"color.grep.match"</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">grep_config</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"color.grep.matchcontext"</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">, </span><span style="color: #953800;">cb</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">grep_config</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"color.grep.matchselected"</span><span style="color: #24292f;">, </span><span style="color: #953800;">value</span><span style="color: #24292f;">, </span><span style="color: #953800;">cb</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; } </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">skip_prefix</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"color.grep."</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">slot</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">i</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">LOOKUP_CONFIG</span><span style="color: #24292f;">(</span><span style="color: #24292f;">color_grep_slots</span><span style="color: #24292f;">, </span><span style="color: #24292f;">slot</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">color</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">i</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">opt</span><span style="color: #24292f;">-&gt;colors[</span><span style="color: #24292f;">i</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">value</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">config_error_nonbool</span><span style="color: #24292f;">(</span><span style="color: #953800;">var</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">color_parse</span><span style="color: #24292f;">(</span><span style="color: #953800;">value</span><span style="color: #24292f;">, </span><span style="color: #24292f;">color</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160;* Initialize one instance of grep_opt and copy the</span></div>
      <div><span style="color: #6e7781;">&#160;* default values from the template we read the configuration</span></div>
      <div><span style="color: #6e7781;">&#160;* information in an earlier call to git_config(grep_config).</span></div>
      <div><span style="color: #6e7781;">&#160;*/</span></div>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_init</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">repository</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">repo</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">prefix</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">grep_defaults</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;repo </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">repo</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;prefix </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">prefix</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;prefix_length </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> (</span><span style="color: #953800;">prefix</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">prefix</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">prefix</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_tail </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_tail </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_list;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_set_pattern_type_option</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pattern_type</span><span style="color: #24292f;"> </span><span style="color: #953800;">pattern_type</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* When committing to the pattern type by setting the relevant</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* fields in grep_opt it's generally not necessary to zero out</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* the fields we're not choosing, since they won't have been</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* set by anything. The extended_regexp_option field is the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* only exception to this.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* This is because in the process of parsing grep.patternType</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* &amp; grep.extendedRegexp we set opt-&gt;pattern_type_option and</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* opt-&gt;extended_regexp_option, respectively. We then</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* internally use opt-&gt;extended_regexp_option to see if we're</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* compiling an ERE. It must be unset if that's not actually</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* the case.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">pattern_type</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_ERE </span><span style="color: #cf222e;">&amp;&amp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended_regexp_option)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended_regexp_option </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">pattern_type</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_UNSPECIFIED:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* fall through */</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_BRE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_ERE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended_regexp_option </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_FIXED:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;fixed </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_PCRE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pcre2 </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_commit_pattern_type</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pattern_type</span><span style="color: #24292f;"> </span><span style="color: #953800;">pattern_type</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">pattern_type</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_UNSPECIFIED)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_set_pattern_type_option</span><span style="color: #24292f;">(</span><span style="color: #953800;">pattern_type</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_type_option </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_PATTERN_TYPE_UNSPECIFIED)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_set_pattern_type_option</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_type_option, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended_regexp_option)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* This branch *must* happen after setting from the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* opt-&gt;pattern_type_option above, we don't want</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* grep.extendedRegexp to override grep.patternType!</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_set_pattern_type_option</span><span style="color: #24292f;">(GREP_PATTERN_TYPE_ERE, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">create_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pat</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">patlen</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">origin</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">no</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat_token</span><span style="color: #24292f;"> </span><span style="color: #953800;">t</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_header_field</span><span style="color: #24292f;"> </span><span style="color: #953800;">field</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xcalloc</span><span style="color: #24292f;">(</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;pattern </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xmemdupz</span><span style="color: #24292f;">(</span><span style="color: #953800;">pat</span><span style="color: #24292f;">, </span><span style="color: #953800;">patlen</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;patternlen </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">patlen</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;origin </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">origin</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;no </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">no</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">t</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">field</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">do_append_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">***</span><span style="color: #953800;">tail</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">**</span><span style="color: #953800;">tail</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">tail</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;next </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;token) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN: </span><span style="color: #6e7781;">/* atom */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (;;) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">new_pat</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">len</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">cp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;pattern </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;patternlen, </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">nl</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">len</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;=</span><span style="color: #24292f;"> </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;patternlen) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">cp</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">nl</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">cp</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">nl</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">new_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">create_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #24292f;">nl</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #24292f;">len</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;origin,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;no, </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;token, </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;field);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">new_pat</span><span style="color: #24292f;">-&gt;next </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;next)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">tail</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">new_pat</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;next </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">new_pat</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">nl</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\0</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;patternlen </span><span style="color: #cf222e;">-=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">len</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">append_header_grep_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_header_field</span><span style="color: #24292f;"> </span><span style="color: #953800;">field</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pat</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">create_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #953800;">pat</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">pat</span><span style="color: #24292f;">), </span><span style="color: #0a3069;">"header"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GREP_PATTERN_HEAD, </span><span style="color: #953800;">field</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">field</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_HEADER_REFLOG)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;use_reflog_filter </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">do_append_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_tail, </span><span style="color: #24292f;">p</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">append_grep_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pat</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">origin</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">no</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat_token</span><span style="color: #24292f;"> </span><span style="color: #953800;">t</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">append_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">pat</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">pat</span><span style="color: #24292f;">), </span><span style="color: #953800;">origin</span><span style="color: #24292f;">, </span><span style="color: #953800;">no</span><span style="color: #24292f;">, </span><span style="color: #953800;">t</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">append_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pat</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">patlen</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">origin</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">no</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat_token</span><span style="color: #24292f;"> </span><span style="color: #953800;">t</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">create_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #953800;">pat</span><span style="color: #24292f;">, </span><span style="color: #953800;">patlen</span><span style="color: #24292f;">, </span><span style="color: #953800;">origin</span><span style="color: #24292f;">, </span><span style="color: #953800;">no</span><span style="color: #24292f;">, </span><span style="color: #953800;">t</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">do_append_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_tail, </span><span style="color: #24292f;">p</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_opt_dup</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">pat</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">ret</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xmalloc</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">ret</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">ret</span><span style="color: #24292f;">-&gt;pattern_list </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">ret</span><span style="color: #24292f;">-&gt;pattern_tail </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">ret</span><span style="color: #24292f;">-&gt;pattern_list;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;">(</span><span style="color: #24292f;">pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list; </span><span style="color: #24292f;">pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">; </span><span style="color: #24292f;">pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;next)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;">(</span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_PATTERN_HEAD)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">append_header_grep_pattern</span><span style="color: #24292f;">(</span><span style="color: #24292f;">ret</span><span style="color: #24292f;">, </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;field,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;pattern);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">append_grep_pat</span><span style="color: #24292f;">(</span><span style="color: #24292f;">ret</span><span style="color: #24292f;">, </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;pattern, </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;patternlen,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;origin, </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;no, </span><span style="color: #24292f;">pat</span><span style="color: #24292f;">-&gt;token);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">ret</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #24292f;">NORETURN</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_regexp_failed</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">error</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">where</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">1024</span><span style="color: #24292f;">];</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;no)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">xsnprintf</span><span style="color: #24292f;">(where, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(where), </span><span style="color: #0a3069;">"In '</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">' at </span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">, "</span><span style="color: #24292f;">, p-&gt;origin, p-&gt;no);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;origin)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">xsnprintf</span><span style="color: #24292f;">(where, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(where), </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">, "</span><span style="color: #24292f;">, p-&gt;origin);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">where</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">': </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, where, p-&gt;pattern, error);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">is_fixed</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">s</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">len</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> i;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (i </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">; i </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> len; i</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">is_regex_special</span><span style="color: #24292f;">(</span><span style="color: #953800;">s</span><span style="color: #24292f;">[i]))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">#ifdef</span><span style="color: #24292f;"> </span><span style="color: #8250df;">USE_LIBPCRE2</span></div>
      <div><span style="color: #cf222e;">#define</span><span style="color: #24292f;"> </span><span style="color: #8250df;">GREP_PCRE2_DEBUG_MALLOC</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">pcre2_malloc</span><span style="color: #24292f;">(PCRE2_SIZE </span><span style="color: #953800;">size</span><span style="color: #24292f;">, MAYBE_UNUSED </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">memory_data</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">pointer </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">malloc</span><span style="color: #24292f;">(size);</span></div>
      <div><span style="color: #cf222e;">#if</span><span style="color: #24292f;"> </span><span style="color: #8250df;">GREP_PCRE2_DEBUG_MALLOC</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> count </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">fprintf</span><span style="color: #24292f;">(stderr, </span><span style="color: #0a3069;">"PCRE2:</span><span style="color: #0550ae;">%p</span><span style="color: #0a3069;"> -&gt; #</span><span style="color: #0550ae;">%02d</span><span style="color: #0a3069;">: alloc(</span><span style="color: #0550ae;">%lu</span><span style="color: #0a3069;">)</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, pointer, count</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">, size);</span></div>
      <div><span style="color: #cf222e;">#endif</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> pointer;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_free</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pointer</span><span style="color: #24292f;">, MAYBE_UNUSED </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">memory_data</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #cf222e;">#if</span><span style="color: #24292f;"> </span><span style="color: #8250df;">GREP_PCRE2_DEBUG_MALLOC</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> count </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (pointer)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">fprintf</span><span style="color: #24292f;">(stderr, </span><span style="color: #0a3069;">"PCRE2:</span><span style="color: #0550ae;">%p</span><span style="color: #0a3069;"> -&gt; #</span><span style="color: #0550ae;">%02d</span><span style="color: #0a3069;">: free()</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, pointer, count</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #cf222e;">#endif</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">(pointer);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pcre2_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_opt </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> error;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; PCRE2_UCHAR </span><span style="color: #953800;">errbuf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">256</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; PCRE2_SIZE erroffset;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> options </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> PCRE2_MULTILINE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> jitret;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> patinforet;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> jitsizearg;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> literal </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">opt-&gt;ignore_case </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> (p-&gt;fixed </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> p-&gt;is_fixed);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* Call pcre2_general_context_create() before calling any</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* other pcre2_*(). It sets up our malloc()/free() functions</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* with which everything else is allocated.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; p-&gt;pcre2_general_context </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_general_context_create</span><span style="color: #24292f;">(</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; pcre2_malloc, pcre2_free, </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p-&gt;pcre2_general_context)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"Couldn't allocate PCRE2 general context"</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (opt-&gt;ignore_case) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">opt-&gt;ignore_locale </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #8250df;">has_non_ascii</span><span style="color: #24292f;">(p-&gt;pattern)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_tables </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_maketables</span><span style="color: #24292f;">(p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_compile_context </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_compile_context_create</span><span style="color: #24292f;">(p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">pcre2_set_character_tables</span><span style="color: #24292f;">(p-&gt;pcre2_compile_context,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_tables);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; options </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> PCRE2_CASELESS;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">opt-&gt;ignore_locale </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #8250df;">is_utf8_locale</span><span style="color: #24292f;">() </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">literal)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; options </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> (PCRE2_UTF </span><span style="color: #cf222e;">|</span><span style="color: #24292f;"> PCRE2_MATCH_INVALID_UTF);</span></div>
      <br>
      <div><span style="color: #cf222e;">#ifdef</span><span style="color: #24292f;"> </span><span style="color: #8250df;">GIT_PCRE2_VERSION_10_36_OR_HIGHER</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* Work around https://bugs.exim.org/show_bug.cgi?id=2642 fixed in 10.36 */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (PCRE2_MATCH_INVALID_UTF </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> options </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;"> (PCRE2_UTF </span><span style="color: #cf222e;">|</span><span style="color: #24292f;"> PCRE2_CASELESS))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; options </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> PCRE2_NO_START_OPTIMIZE;</span></div>
      <div><span style="color: #cf222e;">#endif</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; p-&gt;pcre2_pattern </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_compile</span><span style="color: #24292f;">((PCRE2_SPTR)p-&gt;pattern,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;p-&gt;patternlen, options, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">error, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">erroffset,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;p-&gt;pcre2_compile_context);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;pcre2_pattern) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; p-&gt;pcre2_match_data </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_match_data_create_from_pattern</span><span style="color: #24292f;">(p-&gt;pcre2_pattern, p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p-&gt;pcre2_match_data)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"Couldn't allocate PCRE2 match data"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; } </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">pcre2_get_error_message</span><span style="color: #24292f;">(error, errbuf, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(errbuf));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_regexp_failed</span><span style="color: #24292f;">(p, (</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">)</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">errbuf);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">pcre2_config</span><span style="color: #24292f;">(PCRE2_CONFIG_JIT, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p-&gt;pcre2_jit_on);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;pcre2_jit_on) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; jitret </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_jit_compile</span><span style="color: #24292f;">(p-&gt;pcre2_pattern, PCRE2_JIT_COMPLETE);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (jitret)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"Couldn't JIT the PCRE2 pattern '</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">', got '</span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, p-&gt;pattern, jitret);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* The pcre2_config(PCRE2_CONFIG_JIT, ...) call just</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* tells us whether the library itself supports JIT,</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* but to see whether we're going to be actually using</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* JIT we need to extract PCRE2_INFO_JITSIZE from the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* pattern *after* we do pcre2_jit_compile() above.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* This is because if the pattern contains the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* (*NO_JIT) verb (see pcre2syntax(3))</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* pcre2_jit_compile() will exit early with 0. If we</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* then proceed to call pcre2_jit_match() further down</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* the line instead of pcre2_match() we'll either</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* segfault (pre PCRE 10.31) or run into a fatal error</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* (post PCRE2 10.31)</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; patinforet </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_pattern_info</span><span style="color: #24292f;">(p-&gt;pcre2_pattern, PCRE2_INFO_JITSIZE, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">jitsizearg);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (patinforet)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"pcre2_pattern_info() failed: </span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, patinforet);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (jitsizearg </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pcre2_jit_on </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2match</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">line</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">match</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> ret, flags </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; PCRE2_SIZE </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">ovector;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; PCRE2_UCHAR </span><span style="color: #953800;">errbuf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">256</span><span style="color: #24292f;">];</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (eflags </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;"> REG_NOTBOL)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; flags </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> PCRE2_NOTBOL;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;pcre2_jit_on)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; ret </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_jit_match</span><span style="color: #24292f;">(p-&gt;pcre2_pattern, (</span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">)line,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> line, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, flags, p-&gt;pcre2_match_data,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; ret </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_match</span><span style="color: #24292f;">(p-&gt;pcre2_pattern, (</span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">)line,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> line, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, flags, p-&gt;pcre2_match_data,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (ret </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> ret </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> PCRE2_ERROR_NOMATCH) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">pcre2_get_error_message</span><span style="color: #24292f;">(ret, errbuf, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(errbuf));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;"> failed with error code </span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">: </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; (p-&gt;pcre2_jit_on </span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"pcre2_jit_match"</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"pcre2_match"</span><span style="color: #24292f;">), ret,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; errbuf);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (ret </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; ovector </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2_get_ovector_pointer</span><span style="color: #24292f;">(p-&gt;pcre2_match_data);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; ret </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; match-&gt;rm_so </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">int</span><span style="color: #24292f;">)</span><span style="color: #953800;">ovector</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; match-&gt;rm_eo </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">int</span><span style="color: #24292f;">)</span><span style="color: #953800;">ovector</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> ret;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">free_pcre2_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">pcre2_compile_context_free</span><span style="color: #24292f;">(p-&gt;pcre2_compile_context);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">pcre2_code_free</span><span style="color: #24292f;">(p-&gt;pcre2_pattern);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">pcre2_match_data_free</span><span style="color: #24292f;">(p-&gt;pcre2_match_data);</span></div>
      <div><span style="color: #cf222e;">#ifdef</span><span style="color: #24292f;"> </span><span style="color: #8250df;">GIT_PCRE2_VERSION_10_34_OR_HIGHER</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">pcre2_maketables_free</span><span style="color: #24292f;">(p-&gt;pcre2_general_context, p-&gt;pcre2_tables);</span></div>
      <div><span style="color: #cf222e;">#else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">((</span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">)p-&gt;pcre2_tables);</span></div>
      <div><span style="color: #cf222e;">#endif</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">pcre2_general_context_free</span><span style="color: #24292f;">(p-&gt;pcre2_general_context);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <div><span style="color: #cf222e;">#else</span><span style="color: #24292f;"> </span><span style="color: #6e7781;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pcre2_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_opt </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"cannot use Perl-compatible regexes when not compiled with USE_LIBPCRE"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">pcre2match</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">line</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">match</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">free_pcre2_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_fixed_regexp</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_opt </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> strbuf sb </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> STRBUF_INIT;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> err;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> regflags </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">basic_regex_quote_buf</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">sb, p-&gt;pattern);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (opt-&gt;ignore_case)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; regflags </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> REG_ICASE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; err </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">regcomp</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p-&gt;regexp, sb.buf, regflags);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">strbuf_release</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">sb);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (err) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">errbuf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">1024</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">regerror</span><span style="color: #24292f;">(err, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p-&gt;regexp, errbuf, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(errbuf));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_regexp_failed</span><span style="color: #24292f;">(p, errbuf);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <div><span style="color: #cf222e;">#endif</span><span style="color: #24292f;"> </span><span style="color: #6e7781;">/* !USE_LIBPCRE2 */</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_regexp</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_opt </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> err;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> regflags </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> REG_NEWLINE;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; p-&gt;word_regexp </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> opt-&gt;word_regexp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; p-&gt;ignore_case </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> opt-&gt;ignore_case;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; p-&gt;fixed </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> opt-&gt;fixed;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">memchr</span><span style="color: #24292f;">(p-&gt;pattern, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, p-&gt;patternlen) </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">opt-&gt;pcre2)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #8250df;">_</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"given pattern contains NULL byte (via -f &lt;file&gt;). This is only supported with -P under PCRE v2"</span><span style="color: #24292f;">));</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; p-&gt;is_fixed </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">is_fixed</span><span style="color: #24292f;">(p-&gt;pattern, p-&gt;patternlen);</span></div>
      <div><span style="color: #cf222e;">#ifdef</span><span style="color: #24292f;"> </span><span style="color: #8250df;">USE_LIBPCRE2</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p-&gt;fixed </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p-&gt;is_fixed) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">no_jit </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"(*NO_JIT)"</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> no_jit_len </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(no_jit);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">starts_with</span><span style="color: #24292f;">(p-&gt;pattern, no_jit) </span><span style="color: #cf222e;">&amp;&amp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #8250df;">is_fixed</span><span style="color: #24292f;">(p-&gt;pattern </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> no_jit_len,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> no_jit_len))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;p-&gt;is_fixed </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160;}</span></div>
      <div><span style="color: #cf222e;">#endif</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;fixed </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> p-&gt;is_fixed) {</span></div>
      <div><span style="color: #cf222e;">#ifdef</span><span style="color: #24292f;"> </span><span style="color: #8250df;">USE_LIBPCRE2</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;is_fixed) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_pcre2_pattern</span><span style="color: #24292f;">(p, opt);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; } </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* E.g. t7811-grep-open.sh relies on the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* pattern being restored.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">old_pattern </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> p-&gt;pattern;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> old_patternlen </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> p-&gt;patternlen;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> strbuf sb </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> STRBUF_INIT;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* There is the PCRE2_LITERAL flag, but it's</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* only in PCRE v2 10.30 and later. Needing to</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* ifdef our way around that and dealing with</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* it + PCRE2_MULTILINE being an error is more</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* complex than just quoting this ourselves.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">strbuf_add</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">sb, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\\</span><span style="color: #0a3069;">Q"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">2</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">strbuf_add</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">sb, p-&gt;pattern, p-&gt;patternlen);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">strbuf_add</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">sb, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\\</span><span style="color: #0a3069;">E"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">2</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pattern </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> sb.buf;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> sb.len;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_pcre2_pattern</span><span style="color: #24292f;">(p, opt);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;pattern </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> old_pattern;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; p-&gt;patternlen </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> old_patternlen;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">strbuf_release</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">sb);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #cf222e;">#else</span><span style="color: #24292f;"> </span><span style="color: #6e7781;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_fixed_regexp</span><span style="color: #24292f;">(p, opt);</span></div>
      <div><span style="color: #cf222e;">#endif</span><span style="color: #24292f;"> </span><span style="color: #6e7781;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (opt-&gt;pcre2) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_pcre2_pattern</span><span style="color: #24292f;">(p, opt);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (p-&gt;ignore_case)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; regflags </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> REG_ICASE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (opt-&gt;extended_regexp_option)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; regflags </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> REG_EXTENDED;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">err</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">regcomp</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p-&gt;regexp, p-&gt;pattern, regflags);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (err) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">errbuf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">1024</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">regerror</span><span style="color: #24292f;">(err, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p-&gt;regexp, errbuf, </span><span style="color: #0550ae;">1024</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_regexp_failed</span><span style="color: #24292f;">(p, errbuf);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_not_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">expr</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xcalloc</span><span style="color: #24292f;">(</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; z-&gt;node </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_NODE_NOT;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; z-&gt;u.unary </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> expr;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> z;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_binexp</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> grep_expr_node </span><span style="color: #953800;">kind</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">right</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xcalloc</span><span style="color: #24292f;">(</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; z-&gt;node </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> kind;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; z-&gt;u.binary.left </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> left;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; z-&gt;u.binary.right </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> right;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> z;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_or_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">right</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_binexp</span><span style="color: #24292f;">(GREP_NODE_OR, left, right);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_and_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #953800;">right</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_binexp</span><span style="color: #24292f;">(GREP_NODE_AND, left, right);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_expr </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">compile_pattern_or</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> grep_pat </span><span style="color: #cf222e;">**</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">compile_pattern_atom</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">x</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN: </span><span style="color: #6e7781;">/* atom */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">CALLOC_ARRAY</span><span style="color: #24292f;">(</span><span style="color: #24292f;">x</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">x</span><span style="color: #24292f;">-&gt;node </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_NODE_ATOM;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">x</span><span style="color: #24292f;">-&gt;u.atom </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">x</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_OPEN_PAREN:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_or</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!*</span><span style="color: #953800;">list</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">token </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_CLOSE_PAREN)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"unmatched parenthesis"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">x</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">compile_pattern_not</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">x</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NOT:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">next)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"--not not followed by pattern expression"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_not</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">x</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"--not followed by non pattern expression"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_not_expr</span><span style="color: #24292f;">(</span><span style="color: #24292f;">x</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_atom</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">compile_pattern_and</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">x</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">y</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_not</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_AND) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">x</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"--and not preceded by pattern expression"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"--and not followed by pattern expression"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">y</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_and</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">y</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"--and not followed by pattern expression"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_and_expr</span><span style="color: #24292f;">(</span><span style="color: #24292f;">x</span><span style="color: #24292f;">, </span><span style="color: #24292f;">y</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">x</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">compile_pattern_or</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">x</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">y</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_and</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">list</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_CLOSE_PAREN) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">y</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_or</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">y</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"not a pattern expression </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;pattern);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_or_expr</span><span style="color: #24292f;">(</span><span style="color: #24292f;">x</span><span style="color: #24292f;">, </span><span style="color: #24292f;">y</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">x</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">compile_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">list</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_or</span><span style="color: #24292f;">(</span><span style="color: #953800;">list</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_true_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">void</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xcalloc</span><span style="color: #24292f;">(</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">z</span><span style="color: #24292f;">-&gt;node </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_NODE_TRUE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">z</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">prep_header_patterns</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">(</span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[GREP_HEADER_FIELD_MAX]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_header_field</span><span style="color: #24292f;"> </span><span style="color: #24292f;">fld</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_list)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_PATTERN_HEAD)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"a non-header pattern in grep header list."</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> GREP_HEADER_FIELD_MIN </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; GREP_HEADER_FIELD_MAX </span><span style="color: #cf222e;">&lt;=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"unknown header field </span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_regexp</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">fld</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">; </span><span style="color: #24292f;">fld</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> GREP_HEADER_FIELD_MAX; </span><span style="color: #24292f;">fld</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">fld</span><span style="color: #24292f;">] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">h</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">pp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_atom</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">pp</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">pp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"malformed header expr"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field]) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">h</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">continue</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field] </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_or_expr</span><span style="color: #24292f;">(</span><span style="color: #24292f;">h</span><span style="color: #24292f;">, </span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;field]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">fld</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">; </span><span style="color: #24292f;">fld</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> GREP_HEADER_FIELD_MAX; </span><span style="color: #24292f;">fld</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">fld</span><span style="color: #24292f;">])</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">continue</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_true_expr</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_or_expr</span><span style="color: #24292f;">(</span><span style="color: #24292f;">header_group</span><span style="color: #24292f;">[</span><span style="color: #24292f;">fld</span><span style="color: #24292f;">], </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">grep_splice_or</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">x</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">y</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">z</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">x</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">assert</span><span style="color: #24292f;">(</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;node </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_NODE_OR);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right </span><span style="color: #cf222e;">&amp;&amp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right-&gt;node </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_NODE_TRUE) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">y</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">z</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_grep_patterns</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">prep_header_patterns</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN: </span><span style="color: #6e7781;">/* atom */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">compile_regexp</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;all_match </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;no_body_match </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">compile_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"incomplete pattern expression: </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;pattern);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;no_body_match </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_not_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;all_match)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_splice_or</span><span style="color: #24292f;">(</span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_or_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #24292f;">header_expr</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;all_match </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">free_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">x</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;node) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_TRUE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_ATOM:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_NOT:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.unary);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_AND:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_OR:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.binary.left);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.binary.right);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">(</span><span style="color: #953800;">x</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">free_grep_patterns</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">n</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">n</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">n</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN: </span><span style="color: #6e7781;">/* atom */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">pcre2_pattern)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free_pcre2_pattern</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">regfree</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">p</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">regexp</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">pattern</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">free_pattern_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #8250df;">end_of_line</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">cp</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #24292f;">l</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">l</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">cp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">l</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">cp</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">l</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #953800;">cp</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">word_char</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">ch</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">isalnum</span><span style="color: #24292f;">(</span><span style="color: #953800;">ch</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">ch</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'_'</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">data</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">size</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">color</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">want_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;color) </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">color</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">]) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">color</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">color</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">data</span><span style="color: #24292f;">, </span><span style="color: #953800;">size</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, GIT_COLOR_RESET, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(GIT_COLOR_RESET));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; } </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">data</span><span style="color: #24292f;">, </span><span style="color: #953800;">size</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">output_sep</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">sign</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;null_following_name)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\0</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">sign</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">show_name</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">name</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">name</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">name</span><span style="color: #24292f;">), </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;null_following_name </span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\0</span><span style="color: #0a3069;">"</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">patmatch</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">line</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">match</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;pcre2_pattern)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">pcre2match</span><span style="color: #24292f;">(</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">line</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">match</span><span style="color: #24292f;">, </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">regexec_buf</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;regexp, </span><span style="color: #953800;">line</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #953800;">line</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #953800;">match</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">eflags</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">strip_timestamp</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">eol_p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol_p</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">--</span><span style="color: #24292f;">eol</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'&gt;'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">continue</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol_p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">++</span><span style="color: #24292f;">eol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">field</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">len</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">} </span><span style="color: #24292f;">header_field</span><span style="color: #cf222e;">[]</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; { </span><span style="color: #0a3069;">"author "</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">7</span><span style="color: #24292f;"> },</span></div>
      <div><span style="color: #24292f;">&#160; &#160; { </span><span style="color: #0a3069;">"committer "</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">10</span><span style="color: #24292f;"> },</span></div>
      <div><span style="color: #24292f;">&#160; &#160; { </span><span style="color: #0a3069;">"reflog "</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">7</span><span style="color: #24292f;"> },</span></div>
      <div><span style="color: #24292f;">};</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">headerless_match_one_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">start</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> ((</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_PATTERN) </span><span style="color: #cf222e;">&amp;&amp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; ((</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_PATTERN_HEAD) </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> (</span><span style="color: #953800;">ctx</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_CONTEXT_HEAD)))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160;</span><span style="color: #953800;">again</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">patmatch</span><span style="color: #24292f;">(</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">, </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;word_regexp) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> ((</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #953800;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_eo </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #953800;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_eo)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"regexp returned nonsense"</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* Match beginning must be either beginning of the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* line, or at word boundary (i.e. the last char must</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* not be a word char). &#160;Similarly, match end must be</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* either end of the line, or at word boundary</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* (i.e. the next char must not be a word char).</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> ( ((</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">word_char</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">[</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so</span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">])) </span><span style="color: #cf222e;">&amp;&amp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;((</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_eo </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> (</span><span style="color: #953800;">eol</span><span style="color: #cf222e;">-</span><span style="color: #953800;">bol</span><span style="color: #24292f;">)) </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">word_char</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">[</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_eo])) )</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; ;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* Words consist of at least one character. */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_so </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_eo)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* There could be more than one match on the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* line, and the first match might not be</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* strict word match. &#160;But later ones could be!</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Forward to the next possible start, i.e. the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* next position following a non-word char.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">word_char</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">[</span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">]) </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">eflags</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> REG_NOTBOL;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">goto</span><span style="color: #24292f;"> </span><span style="color: #953800;">again</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">hit</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_so </span><span style="color: #cf222e;">+=</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #24292f;">start</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">].rm_eo </span><span style="color: #cf222e;">+=</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #24292f;">start</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_one_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">field</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">len</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_PATTERN_HEAD) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">assert</span><span style="color: #24292f;">(</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;field </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #8250df;">ARRAY_SIZE</span><span style="color: #24292f;">(</span><span style="color: #24292f;">header_field</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">field</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">header_field</span><span style="color: #24292f;">[</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;field].field;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">len</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">header_field</span><span style="color: #24292f;">[</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;field].len;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">strncmp</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">field</span><span style="color: #24292f;">, </span><span style="color: #24292f;">len</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">len</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">p</span><span style="color: #24292f;">-&gt;field) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_HEADER_AUTHOR:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_HEADER_COMMITTER:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">strip_timestamp</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">eol</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">headerless_match_one_pattern</span><span style="color: #24292f;">(</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">, </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">x</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">x</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"Not a valid grep expression"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;node) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_TRUE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_ATOM:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_one_pattern</span><span style="color: #24292f;">(</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.atom, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">.rm_so;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.atom</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">token </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_PATTERN_BODY)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;body_hit </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">h</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_NOT:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* Upon visiting a GREP_NODE_NOT, col and icol become swapped.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.unary, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_AND:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.binary.left, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">columnnum) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Don't short-circuit AND when given --column, since a</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* NOT earlier in the tree may turn this into an OR. In</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* this case, see the below comment.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">, </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_NODE_OR:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">(</span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">columnnum)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Don't short-circuit OR when given --column (or</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* collecting hits) to ensure we don't skip a later</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* child that would produce an earlier match.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.left, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">, </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">, </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.binary.left, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.left-&gt;hit </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">h</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">h</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">u.binary.right, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">die</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"Unexpected node type (internal error) </span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #953800;">x</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">node</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;hit </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">h</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">h</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr_eval</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">x</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">, </span><span style="color: #953800;">icol</span><span style="color: #24292f;">, </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_line</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">icol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_expr</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">col</span><span style="color: #24292f;">, </span><span style="color: #953800;">icol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* we do not call with collect_hits without being extended */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">match_one_pattern</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;columnnum) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* Without --column, any single match on a line</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* is enough to know that it needs to be</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* printed. With --column, scan _all_ patterns</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* to find the earliest.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">col</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">tmp</span><span style="color: #24292f;">.rm_so;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_next_pattern</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">headerless_match_one_pattern</span><span style="color: #24292f;">(</span><span style="color: #953800;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">match</span><span style="color: #24292f;">, </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_so </span><span style="color: #cf222e;">&gt;=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_eo </span><span style="color: #cf222e;">&gt;=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_so)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_so </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_eo)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_so </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_eo </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_next_match</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_header_field</span><span style="color: #24292f;"> </span><span style="color: #953800;">field</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_so </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">-&gt;rm_eo </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> ((</span><span style="color: #953800;">ctx</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_CONTEXT_HEAD)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;header_list </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> ((</span><span style="color: #953800;">field</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_HEADER_FIELD_MAX) </span><span style="color: #cf222e;">&amp;&amp;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #24292f;">p</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">field </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #953800;">field</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">continue</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* fall thru */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN: </span><span style="color: #6e7781;">/* atom */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">|=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_next_pattern</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">ctx</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">pmatch</span><span style="color: #24292f;">, </span><span style="color: #953800;">eflags</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">show_line_header</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">name</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">cno</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">sign</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;heading </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">name</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">name</span><span style="color: #24292f;">), </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;heading </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pathname) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">name</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">name</span><span style="color: #24292f;">), </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_sep</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">sign</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;linenum) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">32</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">xsnprintf</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">), </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">%d</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #953800;">lno</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">), </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_LINENO]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_sep</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">sign</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* Treat 'cno' as the 1-indexed offset from the start of a non-context</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* line to its first match. Otherwise, 'cno' is 0 indicating that we are</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* being called with a context line.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;columnnum </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">cno</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">32</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">xsnprintf</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">), </span><span style="color: #0a3069;">"%"</span><span style="color: #24292f;">PRIuMAX, (</span><span style="color: #cf222e;">uintmax_t</span><span style="color: #24292f;">)cno);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">), </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_COLUMNNO]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_sep</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">sign</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">show_line</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">name</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #953800;">cno</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #953800;">sign</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">rest</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">match_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">line_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;file_break </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;show_hunk_mark)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; } </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pre_context </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;post_context </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcbody) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;show_hunk_mark) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"--"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">2</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; } </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"--"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">2</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;only_matching) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* In case the line we're being called with contains more than</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* one match, leave printing each header to the loop below.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_line_header</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">name</span><span style="color: #24292f;">, </span><span style="color: #953800;">lno</span><span style="color: #24292f;">, </span><span style="color: #953800;">cno</span><span style="color: #24292f;">, </span><span style="color: #953800;">sign</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;color </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;only_matching) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #24292f;">ctx</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_CONTEXT_BODY;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">eflags</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;color) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">sign</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">':'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">match_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_MATCH_SELECTED];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">match_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_MATCH_CONTEXT];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">sign</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">':'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">line_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_SELECTED];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">sign</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'-'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">line_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_CONTEXT];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">sign</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'='</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">line_color</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_FUNCTION];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">grep_next_match</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">ctx</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">match</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GREP_HEADER_FIELD_MAX, </span><span style="color: #24292f;">eflags</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;only_matching)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_line_header</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">name</span><span style="color: #24292f;">, </span><span style="color: #953800;">lno</span><span style="color: #24292f;">, </span><span style="color: #953800;">cno</span><span style="color: #24292f;">, </span><span style="color: #953800;">sign</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so, </span><span style="color: #24292f;">line_color</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_so, </span><span style="color: #24292f;">match_color</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;only_matching)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">cno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">rest</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">match</span><span style="color: #24292f;">.rm_eo;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">eflags</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> REG_NOTBOL;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;only_matching) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">rest</span><span style="color: #24292f;">, </span><span style="color: #24292f;">line_color</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">grep_use_locks</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160;* This lock protects access to the gitattributes machinery, which is</span></div>
      <div><span style="color: #6e7781;">&#160;* not thread-safe.</span></div>
      <div><span style="color: #6e7781;">&#160;*/</span></div>
      <div><span style="color: #cf222e;">pthread_mutex_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">grep_attr_mutex</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">inline</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_attr_lock</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">void</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">grep_use_locks</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">pthread_mutex_lock</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">grep_attr_mutex</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">inline</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_attr_unlock</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">void</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">grep_use_locks</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">pthread_mutex_unlock</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">grep_attr_mutex</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_funcname</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #0550ae;">xdemitconf_t</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">xecfg </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;priv;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (xecfg </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">xecfg-&gt;find_func) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_source_load_driver</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;repo-&gt;index);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver-&gt;funcname.pattern) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">userdiff_funcname</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">pe</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver-&gt;funcname;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">xdiff_set_find_func</span><span style="color: #24292f;">(xecfg, </span><span style="color: #24292f;">pe</span><span style="color: #24292f;">-&gt;pattern, </span><span style="color: #24292f;">pe</span><span style="color: #24292f;">-&gt;cflags);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; } </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; xecfg </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;priv </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (xecfg) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> xecfg-&gt;</span><span style="color: #8250df;">find_func</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; xecfg-&gt;find_func_priv) </span><span style="color: #cf222e;">&gt;=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">isalpha</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'_'</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'$'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">show_funcname_line</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">--</span><span style="color: #953800;">bol</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">[</span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">] </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">lno</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">match_funcname</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name, </span><span style="color: #953800;">lno</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">'='</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">is_empty_line</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">show_pre_context</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">end</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #24292f;">cur</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">, </span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #24292f;">funcname_lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, </span><span style="color: #24292f;">orig_from</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">funcname_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcname, </span><span style="color: #24292f;">comment_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pre_context </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pre_context;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">orig_from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">from</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcbody) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">match_funcname</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #953800;">end</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">comment_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">funcname_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* Rewind. */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">cur</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">from</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">next_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">--</span><span style="color: #953800;">bol</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&gt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">[</span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">] </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">cur</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">comment_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">is_empty_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #8250df;">match_funcname</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">))) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">comment_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">orig_from</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">cur</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">from</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">cur</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">next_bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">funcname_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_funcname</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">funcname_lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">cur</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">funcname_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcbody)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">comment_needed</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">from</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">orig_from</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* We need to look even further back to find a function signature. */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcname </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">funcname_needed</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_funcname_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">cur</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* Back forward. */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">cur</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">lno</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">sign</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">cur</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #24292f;">funcname_lno</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'='</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'-'</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">eol</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name, </span><span style="color: #24292f;">cur</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, </span><span style="color: #24292f;">sign</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">cur</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">should_lookahead</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;extended)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">; </span><span style="color: #6e7781;">/* punt for too complex stuff */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;invert)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;token </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_PATTERN)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">; </span><span style="color: #6e7781;">/* punt for "header only" and stuff */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">look_ahead</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left_p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">lno_p</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">**</span><span style="color: #953800;">bol_p</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #24292f;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">lno_p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol_p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_pat</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">sp</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">last_bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #0550ae;">regoff_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">earliest</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_list; </span><span style="color: #24292f;">p</span><span style="color: #24292f;">; </span><span style="color: #24292f;">p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">p</span><span style="color: #24292f;">-&gt;next) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #0550ae;">regmatch_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">m</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">patmatch</span><span style="color: #24292f;">(</span><span style="color: #24292f;">p</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left_p</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">m</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">m</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">m</span><span style="color: #24292f;">.rm_eo </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">continue</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">earliest</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">m</span><span style="color: #24292f;">.rm_so </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">earliest</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">earliest</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">m</span><span style="color: #24292f;">.rm_so;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">earliest</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol_p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left_p</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left_p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">sp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #24292f;">earliest</span><span style="color: #24292f;">; </span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">sp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">sp</span><span style="color: #24292f;">[</span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">] </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">; </span><span style="color: #24292f;">sp</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; ; </span><span style="color: #6e7781;">/* find the beginning of the line */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">last_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">sp</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">for</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">sp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">; </span><span style="color: #24292f;">sp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">last_bol</span><span style="color: #24292f;">; </span><span style="color: #24292f;">sp</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">*</span><span style="color: #24292f;">sp</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0a3069;">'</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">'</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">lno</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">left_p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">last_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol_p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">last_bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">*</span><span style="color: #953800;">lno_p</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">lno</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">fill_textconv_grep</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">repository</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">r</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">userdiff_driver</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">driver</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">diff_filespec</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">df</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">size</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">driver</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #953800;">driver</span><span style="color: #24292f;">-&gt;textconv)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* The textconv interface is intimately tied to diff_filespecs, so we</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* have to pretend to be one. If we could unify the grep_source</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* and diff_filespec structs, this mess could just go away.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">df</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">alloc_filespec</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;type) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">fill_filespec</span><span style="color: #24292f;">(</span><span style="color: #24292f;">df</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">identifier</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">0</span><span style="color: #0550ae;">100644</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">fill_filespec</span><span style="color: #24292f;">(</span><span style="color: #24292f;">df</span><span style="color: #24292f;">, </span><span style="color: #8250df;">null_oid</span><span style="color: #24292f;">(), </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">0</span><span style="color: #0550ae;">100644</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"attempt to textconv something without a path?"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* fill_textconv is not remotely thread-safe; it modifies the global</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* diff tempfile structure, writes to the_repo's odb and might</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* internally call thread-unsafe functions such as the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* prepare_packed_git() lazy-initializator. Because of the last two, we</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* must ensure mutual exclusion between this call and the object reading</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* API, thus we use obj_read_lock() here.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* TODO: allowing text conversion to run in parallel with object</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* reading operations might increase performance in the multithreaded</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* non-worktreee git-grep with --textconv.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">obj_read_lock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">size</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">fill_textconv</span><span style="color: #24292f;">(</span><span style="color: #953800;">r</span><span style="color: #24292f;">, </span><span style="color: #953800;">driver</span><span style="color: #24292f;">, </span><span style="color: #24292f;">df</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">obj_read_unlock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">free_filespec</span><span style="color: #24292f;">(</span><span style="color: #24292f;">df</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* The normal fill_textconv usage by the diff machinery would just keep</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* the textconv'd buf separate from the diff_filespec. But much of the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* grep code passes around a grep_source and assumes that its "buf"</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* pointer is the beginning of the thing we are searching. So let's</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* install our textconv'd version into the grep_source, taking care not</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* to leak any existing buffer.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_source_clear_data</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">size</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">is_empty_line</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">eol</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #8250df;">isspace</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">*</span><span style="color: #953800;">bol</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">bol</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #953800;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #953800;">eol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_1</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #24292f;">left</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #24292f;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #24292f;">last_hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">binary_match_only</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #24292f;">count</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">try_lookahead</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">show_function</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">userdiff_driver</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">textconv</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_context</span><span style="color: #24292f;"> </span><span style="color: #24292f;">ctx</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_CONTEXT_HEAD;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #0550ae;">xdemitconf_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">xecfg</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;status_only </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"grep call which could print a name requires "</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0a3069;">"grep_source.name be non-NULL"</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;output)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;output </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">std_output</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pre_context </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;post_context </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;file_break </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcbody) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* Show hunk marks, except for the first file. */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;show_hunk_mark </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* If we're using threads then we can't easily identify</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* the first file. &#160;Always put hunk marks in that case</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* and skip the very first one later in work_done().</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;output </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">std_output</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;show_hunk_mark </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;last_shown </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;allow_textconv) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_source_load_driver</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;repo-&gt;index);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* We might set up the shared textconv cache data here, which</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* is not thread-safe. Also, get_oid_with_context() and</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* parse_object() might be internally called. As they are not</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* currently thread-safe and might be racy with object reading,</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* obj_read_lock() must be called.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_attr_lock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">obj_read_lock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">textconv</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">userdiff_get_textconv</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;repo, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">obj_read_unlock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">grep_attr_unlock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* We know the result of a textconv is text, so we only have to care</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* about binary handling if we are not using it.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">textconv</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;binary) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_BINARY_DEFAULT:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">grep_source_is_binary</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">repo</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">index</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">binary_match_only</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_BINARY_NOMATCH:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">grep_source_is_binary</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">opt</span><span style="color: #cf222e;">-&gt;</span><span style="color: #24292f;">repo</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">index</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">; </span><span style="color: #6e7781;">/* Assume unmatch */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_BINARY_TEXT:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">default</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"unknown binary handling mode"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">memset</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">xecfg</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #24292f;">xecfg</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;priv </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">xecfg</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">try_lookahead</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">should_lookahead</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">fill_textconv_grep</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;repo, </span><span style="color: #24292f;">textconv</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">left</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">left</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">eol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">cno</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">ssize_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">col</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #24292f;">icol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* look_ahead() skips quickly to the line that possibly</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* has the next hit; don't call it if we need to do</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* something more than just skipping the current line</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* in response to an unmatch for the current line. &#160;E.g.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* inside a post-context window, we will show the current</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* line as a context around the previous hit when it</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* doesn't hit.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">try_lookahead</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">(</span><span style="color: #24292f;">last_hit</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">show_function</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #24292f;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">last_hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;post_context))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #8250df;">look_ahead</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">left</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">lno</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">bol</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">end_of_line</span><span style="color: #24292f;">(</span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">left</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> ((</span><span style="color: #24292f;">ctx</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> GREP_CONTEXT_HEAD) </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">==</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">ctx</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_CONTEXT_BODY;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">match_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">col</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">icol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">ctx</span><span style="color: #24292f;">, </span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">goto</span><span style="color: #24292f;"> </span><span style="color: #953800;">next_line</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* "grep -v -e foo -e bla" should list lines</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* that do not have either, so inversion should</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;* be done outside.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;invert)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #24292f;">hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;unmatch_name_only) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">hit</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">goto</span><span style="color: #24292f;"> </span><span style="color: #953800;">next_line</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">hit</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">count</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;status_only)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;name_only) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_name</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;count)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">goto</span><span style="color: #24292f;"> </span><span style="color: #953800;">next_line</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">binary_match_only</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">"Binary file "</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">12</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name),</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">" matches</span><span style="color: #0550ae;">\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">9</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* Hit at this line. &#160;If we haven't shown the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* pre-context lines, we would need to show them.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pre_context </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcbody)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_pre_context</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">lno</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">else</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcname)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_funcname_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">lno</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">cno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;invert </span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #24292f;">icol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #24292f;">col</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">cno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* A negative cno indicates that there was no</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* match on the line. We are thus inverted and</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* being asked to show all lines that _don't_</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* match a given expression. Therefore, set cno</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* to 0 to suggest the whole line matches.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">cno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name, </span><span style="color: #24292f;">lno</span><span style="color: #24292f;">, </span><span style="color: #24292f;">cno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">':'</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">last_hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">lno</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;funcbody)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">show_function</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">goto</span><span style="color: #24292f;"> </span><span style="color: #953800;">next_line</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">show_function</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span><span style="color: #24292f;"> </span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #24292f;">peek_left</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">left</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">peek_eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Trailing empty lines are not interesting.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Peek past them to see if they belong to the</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* body of the current function.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">is_empty_line</span><span style="color: #24292f;">(</span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">peek_eol</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">peek_eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">peek_eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">end_of_line</span><span style="color: #24292f;">(</span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">peek_left</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">match_funcname</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #24292f;">peek_bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">peek_eol</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #24292f;">show_function</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">show_function</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">||</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #24292f;">last_hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">lno</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">last_hit</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;post_context)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* If the last hit is within the post context,</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* we need to show this line.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_line</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">bol</span><span style="color: #24292f;">, </span><span style="color: #24292f;">eol</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name, </span><span style="color: #24292f;">lno</span><span style="color: #24292f;">, </span><span style="color: #24292f;">col</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">'-'</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">next_line</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">bol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">eol</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">+</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #24292f;">left</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">left</span><span style="color: #cf222e;">--</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #24292f;">lno</span><span style="color: #cf222e;">++</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">collect_hits</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;status_only)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;unmatch_name_only;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;unmatch_name_only) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* We did not see any hit, so we want to show this */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">show_name</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">xdiff_clear_find_func</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">xecfg</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;priv </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* NEEDSWORK:</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* The real "grep -c foo *.c" gives many "bar.c:0" lines,</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* which feels mostly useless but sometimes useful. &#160;Maybe</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* make it another option? &#160;For now suppress them.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;count </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #24292f;">count</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">[</span><span style="color: #0550ae;">32</span><span style="color: #24292f;">];</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pathname) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_color</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name),</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;colors[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">output_sep</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #0a3069;">':'</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">xsnprintf</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">sizeof</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">), </span><span style="color: #0a3069;">"</span><span style="color: #0550ae;">%u\n</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">, </span><span style="color: #24292f;">count</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;</span><span style="color: #8250df;">output</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #24292f;">buf</span><span style="color: #24292f;">, </span><span style="color: #8250df;">strlen</span><span style="color: #24292f;">(</span><span style="color: #24292f;">buf</span><span style="color: #24292f;">));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!!</span><span style="color: #24292f;">last_hit</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">clr_hit_marker</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">x</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* All-hit markers are meaningful only at the very top level</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* OR node.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;hit </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;node </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_NODE_OR)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.left-&gt;hit </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">chk_hit_marker</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_expr</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">x</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* Top level nodes have hit markers. &#160;See if they all are hits */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">while</span><span style="color: #24292f;"> (</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;node </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> GREP_NODE_OR)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;hit;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.left-&gt;hit)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">x</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">x</span><span style="color: #24292f;">-&gt;u.binary.right;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/*</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* we do not have to do the two-pass grep when we do not check</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* buffer-wide "all-match".</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;all_match </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;no_body_match)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_1</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #6e7781;">/* Otherwise the toplevel "or" terms hit a bit differently.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;* We first clear hit markers from them.</span></div>
      <div><span style="color: #6e7781;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">clr_hit_marker</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;body_hit </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_source_1</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">1</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;all_match </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">!</span><span style="color: #8250df;">chk_hit_marker</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;pattern_expression))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;no_body_match </span><span style="color: #cf222e;">&amp;&amp;</span><span style="color: #24292f;"> </span><span style="color: #953800;">opt</span><span style="color: #24292f;">-&gt;body_hit)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_1</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_init_buf</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">buf</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #953800;">size</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;type </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_SOURCE_BUF;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">buf</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">size</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_buffer</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_opt</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">buf</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">unsigned</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">long</span><span style="color: #24292f;"> </span><span style="color: #953800;">size</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #24292f;">gs</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">r</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_source_init_buf</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">buf</span><span style="color: #24292f;">, </span><span style="color: #953800;">size</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">r</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source</span><span style="color: #24292f;">(</span><span style="color: #953800;">opt</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">gs</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_source_clear</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">gs</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #24292f;">r</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_init_file</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">name</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">path</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;type </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_SOURCE_FILE;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xstrdup_or_null</span><span style="color: #24292f;">(</span><span style="color: #953800;">name</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xstrdup_or_null</span><span style="color: #24292f;">(</span><span style="color: #953800;">path</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xstrdup</span><span style="color: #24292f;">(</span><span style="color: #953800;">path</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_init_oid</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">name</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">path</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">object_id</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">oid</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">repository</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">repo</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;type </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> GREP_SOURCE_OID;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xstrdup_or_null</span><span style="color: #24292f;">(</span><span style="color: #953800;">name</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xstrdup_or_null</span><span style="color: #24292f;">(</span><span style="color: #953800;">path</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">oiddup</span><span style="color: #24292f;">(</span><span style="color: #953800;">oid</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;repo </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">repo</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_clear</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">FREE_AND_NULL</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">FREE_AND_NULL</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">FREE_AND_NULL</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_source_clear_data</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_clear_data</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;type) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* these types own the buffer */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">((</span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">)</span><span style="color: #953800;">gs</span><span style="color: #cf222e;">-&gt;</span><span style="color: #953800;">buf</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">NULL</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_BUF:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #6e7781;">/* leave user-provided buf intact */</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">break</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load_oid</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">enum</span><span style="color: #24292f;"> </span><span style="color: #953800;">object_type</span><span style="color: #24292f;"> </span><span style="color: #24292f;">type</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">repo_read_object_file</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;repo, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">type</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">&amp;</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">error</span><span style="color: #24292f;">(</span><span style="color: #8250df;">_</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"'</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">': unable to read </span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">"</span><span style="color: #24292f;">),</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;name,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #8250df;">oid_to_hex</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier));</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load_file</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">const</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">filename</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;identifier;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">stat</span><span style="color: #24292f;"> </span><span style="color: #24292f;">st</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">char</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #24292f;">data</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">size_t</span><span style="color: #24292f;"> </span><span style="color: #24292f;">size</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #24292f;">i</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #8250df;">lstat</span><span style="color: #24292f;">(</span><span style="color: #24292f;">filename</span><span style="color: #24292f;">, </span><span style="color: #cf222e;">&amp;</span><span style="color: #24292f;">st</span><span style="color: #24292f;">) </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">err_ret</span><span style="color: #24292f;">:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (errno </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> ENOENT)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #8250df;">error_errno</span><span style="color: #24292f;">(</span><span style="color: #8250df;">_</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"failed to stat '</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">'"</span><span style="color: #24292f;">), </span><span style="color: #24292f;">filename</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">S_ISREG</span><span style="color: #24292f;">(</span><span style="color: #24292f;">st</span><span style="color: #24292f;">.st_mode))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">size</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xsize_t</span><span style="color: #24292f;">(</span><span style="color: #24292f;">st</span><span style="color: #24292f;">.st_size);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">i</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">open</span><span style="color: #24292f;">(</span><span style="color: #24292f;">filename</span><span style="color: #24292f;">, O_RDONLY);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">i</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">&lt;</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">goto</span><span style="color: #24292f;"> </span><span style="color: #953800;">err_ret</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #24292f;">data</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">xmallocz</span><span style="color: #24292f;">(</span><span style="color: #24292f;">size</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #24292f;">st</span><span style="color: #24292f;">.st_size </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">read_in_full</span><span style="color: #24292f;">(</span><span style="color: #24292f;">i</span><span style="color: #24292f;">, </span><span style="color: #24292f;">data</span><span style="color: #24292f;">, </span><span style="color: #24292f;">size</span><span style="color: #24292f;">)) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">error_errno</span><span style="color: #24292f;">(</span><span style="color: #8250df;">_</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"'</span><span style="color: #0550ae;">%s</span><span style="color: #0a3069;">': short read"</span><span style="color: #24292f;">), </span><span style="color: #24292f;">filename</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">close</span><span style="color: #24292f;">(</span><span style="color: #24292f;">i</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #8250df;">free</span><span style="color: #24292f;">(</span><span style="color: #24292f;">data</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">close</span><span style="color: #24292f;">(</span><span style="color: #24292f;">i</span><span style="color: #24292f;">);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">data</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #24292f;">size</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">switch</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;type) {</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load_file</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load_oid</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">case</span><span style="color: #24292f;"> GREP_SOURCE_BUF:</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf </span><span style="color: #cf222e;">?</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">:</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">&#160; &#160; }</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">BUG</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"invalid grep_source type to load"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">void</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_load_driver</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">index_state</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">istate</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;">;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_attr_lock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">userdiff_find_by_path</span><span style="color: #24292f;">(</span><span style="color: #953800;">istate</span><span style="color: #24292f;">, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;path);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver </span><span style="color: #cf222e;">=</span><span style="color: #24292f;"> </span><span style="color: #8250df;">userdiff_find_by_name</span><span style="color: #24292f;">(</span><span style="color: #0a3069;">"default"</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_attr_unlock</span><span style="color: #24292f;">();</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
      <div><span style="color: #cf222e;">static</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">int</span><span style="color: #24292f;"> </span><span style="color: #8250df;">grep_source_is_binary</span><span style="color: #24292f;">(</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">grep_source</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">gs</span><span style="color: #24292f;">,</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #cf222e;">struct</span><span style="color: #24292f;"> </span><span style="color: #953800;">index_state</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">*</span><span style="color: #953800;">istate</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">{</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #8250df;">grep_source_load_driver</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">, </span><span style="color: #953800;">istate</span><span style="color: #24292f;">);</span></div>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver-&gt;binary </span><span style="color: #cf222e;">!=</span><span style="color: #24292f;"> </span><span style="color: #cf222e;">-</span><span style="color: #0550ae;">1</span><span style="color: #24292f;">)</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;driver-&gt;binary;</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">if</span><span style="color: #24292f;"> (</span><span style="color: #cf222e;">!</span><span style="color: #8250df;">grep_source_load</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">))</span></div>
      <div><span style="color: #24292f;">&#160; &#160; &#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #8250df;">buffer_is_binary</span><span style="color: #24292f;">(</span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;buf, </span><span style="color: #953800;">gs</span><span style="color: #24292f;">-&gt;size);</span></div>
      <br>
      <div><span style="color: #24292f;">&#160; &#160; </span><span style="color: #cf222e;">return</span><span style="color: #24292f;"> </span><span style="color: #0550ae;">0</span><span style="color: #24292f;">;</span></div>
      <div><span style="color: #24292f;">}</span></div>
      <br>
    </div>
    <!--EndFragment-->
  </body>
</html>
