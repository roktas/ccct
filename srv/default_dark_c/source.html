<html>
  <body>
    <!--StartFragment-->
    <div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;">
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"cache.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"config.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"grep.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"object-store.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"userdiff.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"xdiff-interface.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"diff.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"diffcore.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"commit.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"quote.h"</span></div>
      <div><span style="color: #c586c0;">#include</span><span style="color: #569cd6;"> </span><span style="color: #ce9178;">"help.h"</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_is_binary</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> index_state *</span><span style="color: #9cdcfe;">istate</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">std_output</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">fwrite</span><span style="color: #d4d4d4;">(buf, size, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, stdout);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt grep_defaults = {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .relative = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .pathname = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .max_depth = -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .pattern_type_option = GREP_PATTERN_TYPE_UNSPECIFIED,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .colors = {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_CONTEXT] = </span><span style="color: #ce9178;">""</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_FILENAME] = GIT_COLOR_MAGENTA,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_FUNCTION] = </span><span style="color: #ce9178;">""</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_LINENO] = GIT_COLOR_GREEN,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_COLUMNNO] = GIT_COLOR_GREEN,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_MATCH_CONTEXT] = GIT_COLOR_BOLD_RED,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_MATCH_SELECTED] = GIT_COLOR_BOLD_RED,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_SELECTED] = </span><span style="color: #ce9178;">""</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; [GREP_COLOR_SEP] = GIT_COLOR_CYAN,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; },</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .only_matching = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .color = -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; .output = std_output,</span></div>
      <div><span style="color: #d4d4d4;">};</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *color_grep_slots</span><span style="color: #569cd6;">[]</span><span style="color: #d4d4d4;"> = {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_CONTEXT] &#160; &#160; &#160; &#160;= </span><span style="color: #ce9178;">"context"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_FILENAME] &#160; &#160; &#160; = </span><span style="color: #ce9178;">"filename"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_FUNCTION] &#160; &#160; &#160; = </span><span style="color: #ce9178;">"function"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_LINENO] &#160; &#160; = </span><span style="color: #ce9178;">"lineNumber"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_COLUMNNO] &#160; &#160; &#160; = </span><span style="color: #ce9178;">"column"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_MATCH_CONTEXT] &#160;= </span><span style="color: #ce9178;">"matchContext"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_MATCH_SELECTED] = </span><span style="color: #ce9178;">"matchSelected"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_SELECTED] &#160; &#160; &#160; = </span><span style="color: #ce9178;">"selected"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; [GREP_COLOR_SEP] &#160; &#160; &#160; &#160;= </span><span style="color: #ce9178;">"separator"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">};</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">parse_pattern_type_arg</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">arg</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(arg, </span><span style="color: #ce9178;">"default"</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_UNSPECIFIED;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(arg, </span><span style="color: #ce9178;">"basic"</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_BRE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(arg, </span><span style="color: #ce9178;">"extended"</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_ERE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(arg, </span><span style="color: #ce9178;">"fixed"</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_FIXED;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(arg, </span><span style="color: #ce9178;">"perl"</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_PCRE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"bad </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;"> argument: </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, opt, arg);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #dcdcaa;">define_list_config_array_extra</span><span style="color: #d4d4d4;">(color_grep_slots, {</span><span style="color: #ce9178;">"match"</span><span style="color: #d4d4d4;">});</span></div>
      <br>
      <div><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160;* Read the configuration file once and store it in</span></div>
      <div><span style="color: #6a9955;">&#160;* the grep_defaults template.</span></div>
      <div><span style="color: #6a9955;">&#160;*/</span></div>
      <div><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_config</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">var</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">value</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">cb</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *opt = &amp;grep_defaults;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *slot;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">userdiff_config</span><span style="color: #d4d4d4;">(var, value) &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* The instance of grep_opt that we set up here is copied by</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* grep_init() to be used by each individual invocation.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* When populating a new field of this structure here, be</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* sure to think about ownership -- e.g., you might need to</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* override the shallow copy in grep_init() with a deep copy.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"grep.extendedregexp"</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended_regexp_option</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">git_config_bool</span><span style="color: #d4d4d4;">(var, value);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"grep.patterntype"</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_type_option</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">parse_pattern_type_arg</span><span style="color: #d4d4d4;">(var, value);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"grep.linenumber"</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">linenum</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">git_config_bool</span><span style="color: #d4d4d4;">(var, value);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"grep.column"</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">columnnum</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">git_config_bool</span><span style="color: #d4d4d4;">(var, value);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"grep.fullname"</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">relative</span><span style="color: #d4d4d4;"> = !</span><span style="color: #dcdcaa;">git_config_bool</span><span style="color: #d4d4d4;">(var, value);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"color.grep"</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">git_config_colorbool</span><span style="color: #d4d4d4;">(var, value);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">strcmp</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"color.grep.match"</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">grep_config</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"color.grep.matchcontext"</span><span style="color: #d4d4d4;">, value, cb) &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">grep_config</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"color.grep.matchselected"</span><span style="color: #d4d4d4;">, value, cb) &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; } </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">skip_prefix</span><span style="color: #d4d4d4;">(var, </span><span style="color: #ce9178;">"color.grep."</span><span style="color: #d4d4d4;">, &amp;slot)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> i = </span><span style="color: #dcdcaa;">LOOKUP_CONFIG</span><span style="color: #d4d4d4;">(color_grep_slots, slot);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *color;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (i &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; color = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[i];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!value)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">config_error_nonbool</span><span style="color: #d4d4d4;">(var);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">color_parse</span><span style="color: #d4d4d4;">(value, color);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160;* Initialize one instance of grep_opt and copy the</span></div>
      <div><span style="color: #6a9955;">&#160;* default values from the template we read the configuration</span></div>
      <div><span style="color: #6a9955;">&#160;* information in an earlier call to git_config(grep_config).</span></div>
      <div><span style="color: #6a9955;">&#160;*/</span></div>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_init</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> repository *</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">prefix</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *opt = grep_defaults;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;"> = repo;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">prefix</span><span style="color: #d4d4d4;"> = prefix;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">prefix_length</span><span style="color: #d4d4d4;"> = (prefix &amp;&amp; *prefix) ? </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(prefix) : </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_tail</span><span style="color: #d4d4d4;"> = &amp;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_tail</span><span style="color: #d4d4d4;"> = &amp;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_list</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_set_pattern_type_option</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_pattern_type </span><span style="color: #9cdcfe;">pattern_type</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* When committing to the pattern type by setting the relevant</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* fields in grep_opt it's generally not necessary to zero out</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* the fields we're not choosing, since they won't have been</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* set by anything. The extended_regexp_option field is the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* only exception to this.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* This is because in the process of parsing grep.patternType</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* &amp; grep.extendedRegexp we set opt-&gt;pattern_type_option and</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* opt-&gt;extended_regexp_option, respectively. We then</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* internally use opt-&gt;extended_regexp_option to see if we're</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* compiling an ERE. It must be unset if that's not actually</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* the case.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (pattern_type != GREP_PATTERN_TYPE_ERE &amp;&amp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended_regexp_option</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended_regexp_option</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (pattern_type) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_UNSPECIFIED:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* fall through */</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_BRE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_ERE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended_regexp_option</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_FIXED:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">fixed</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_TYPE_PCRE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_commit_pattern_type</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_pattern_type </span><span style="color: #9cdcfe;">pattern_type</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (pattern_type != GREP_PATTERN_TYPE_UNSPECIFIED)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_set_pattern_type_option</span><span style="color: #d4d4d4;">(pattern_type, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_type_option</span><span style="color: #d4d4d4;"> != GREP_PATTERN_TYPE_UNSPECIFIED)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_set_pattern_type_option</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_type_option</span><span style="color: #d4d4d4;">, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended_regexp_option</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* This branch *must* happen after setting from the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* opt-&gt;pattern_type_option above, we don't want</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* grep.extendedRegexp to override grep.patternType!</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_set_pattern_type_option</span><span style="color: #d4d4d4;">(GREP_PATTERN_TYPE_ERE, opt);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #dcdcaa;">create_grep_pat</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">patlen</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_pat_token </span><span style="color: #9cdcfe;">t</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_header_field </span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p = </span><span style="color: #dcdcaa;">xcalloc</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(*p));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">xmemdupz</span><span style="color: #d4d4d4;">(pat, patlen);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;"> = patlen;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;"> = origin;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;"> = no;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> = t;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;"> = field;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> p;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">do_append_grep_pat</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat ***</span><span style="color: #9cdcfe;">tail</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; **tail = p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *tail = &amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN: </span><span style="color: #6a9955;">/* atom */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (;;) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *new_pat;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> len = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *cp = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;"> + </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">, *nl = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (++len &lt;= </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (*(--cp) == </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; nl = cp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!nl)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; new_pat = </span><span style="color: #dcdcaa;">create_grep_pat</span><span style="color: #d4d4d4;">(nl + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, len - </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">new_pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; *tail = &amp;</span><span style="color: #9cdcfe;">new_pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;"> = new_pat;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; *nl = </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\0</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;"> -= len;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">append_header_grep_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_header_field </span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p = </span><span style="color: #dcdcaa;">create_grep_pat</span><span style="color: #d4d4d4;">(pat, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(pat), </span><span style="color: #ce9178;">"header"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GREP_PATTERN_HEAD, field);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (field == GREP_HEADER_REFLOG)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">use_reflog_filter</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">do_append_grep_pat</span><span style="color: #d4d4d4;">(&amp;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_tail</span><span style="color: #d4d4d4;">, p);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">append_grep_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_pat_token </span><span style="color: #9cdcfe;">t</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">append_grep_pat</span><span style="color: #d4d4d4;">(opt, pat, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(pat), origin, no, t);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">append_grep_pat</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">patlen</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_pat_token </span><span style="color: #9cdcfe;">t</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p = </span><span style="color: #dcdcaa;">create_grep_pat</span><span style="color: #d4d4d4;">(pat, patlen, origin, no, t, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">do_append_grep_pat</span><span style="color: #d4d4d4;">(&amp;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_tail</span><span style="color: #d4d4d4;">, p);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #dcdcaa;">grep_opt_dup</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *pat;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *ret = </span><span style="color: #dcdcaa;">xmalloc</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *ret = *opt;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">ret</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">ret</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_tail</span><span style="color: #d4d4d4;"> = &amp;</span><span style="color: #9cdcfe;">ret</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;">(pat = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">; pat != </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">; pat = </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> == GREP_PATTERN_HEAD)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">append_header_grep_pattern</span><span style="color: #d4d4d4;">(ret, </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">append_grep_pat</span><span style="color: #d4d4d4;">(ret, </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">pat</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> ret;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> NORETURN </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_regexp_failed</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">error</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">where</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">1024</span><span style="color: #d4d4d4;">];</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">xsnprintf</span><span style="color: #d4d4d4;">(where, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(where), </span><span style="color: #ce9178;">"In '</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">' at </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">, "</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">xsnprintf</span><span style="color: #d4d4d4;">(where, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(where), </span><span style="color: #ce9178;">"</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">, "</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">origin</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">where</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">] = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">'</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">': </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, where, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, error);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">is_fixed</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">len</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> i;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (i = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; i &lt; len; i++) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">is_regex_special</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">[i]))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #c586c0;">#ifdef</span><span style="color: #569cd6;"> USE_LIBPCRE2</span></div>
      <div><span style="color: #c586c0;">#define</span><span style="color: #569cd6;"> GREP_PCRE2_DEBUG_MALLOC </span><span style="color: #b5cea8;">0</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #dcdcaa;">pcre2_malloc</span><span style="color: #d4d4d4;">(PCRE2_SIZE </span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">, MAYBE_UNUSED </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">memory_data</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *pointer = </span><span style="color: #dcdcaa;">malloc</span><span style="color: #d4d4d4;">(size);</span></div>
      <div><span style="color: #c586c0;">#if</span><span style="color: #569cd6;"> GREP_PCRE2_DEBUG_MALLOC</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> count = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">fprintf</span><span style="color: #d4d4d4;">(stderr, </span><span style="color: #ce9178;">"PCRE2:</span><span style="color: #9cdcfe;">%p</span><span style="color: #ce9178;"> -&gt; #</span><span style="color: #9cdcfe;">%02d</span><span style="color: #ce9178;">: alloc(</span><span style="color: #9cdcfe;">%lu</span><span style="color: #ce9178;">)</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, pointer, count++, size);</span></div>
      <div><span style="color: #c586c0;">#endif</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> pointer;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">pcre2_free</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pointer</span><span style="color: #d4d4d4;">, MAYBE_UNUSED </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">memory_data</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #c586c0;">#if</span><span style="color: #569cd6;"> GREP_PCRE2_DEBUG_MALLOC</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> count = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (pointer)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">fprintf</span><span style="color: #d4d4d4;">(stderr, </span><span style="color: #ce9178;">"PCRE2:</span><span style="color: #9cdcfe;">%p</span><span style="color: #ce9178;"> -&gt; #</span><span style="color: #9cdcfe;">%02d</span><span style="color: #ce9178;">: free()</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, pointer, count++);</span></div>
      <div><span style="color: #c586c0;">#endif</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">(pointer);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_pcre2_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> error;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; PCRE2_UCHAR </span><span style="color: #9cdcfe;">errbuf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">256</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; PCRE2_SIZE erroffset;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> options = PCRE2_MULTILINE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> jitret;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> patinforet;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> jitsizearg;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> literal = !</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_case</span><span style="color: #d4d4d4;"> &amp;&amp; (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">fixed</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">is_fixed</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* Call pcre2_general_context_create() before calling any</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* other pcre2_*(). It sets up our malloc()/free() functions</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* with which everything else is allocated.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">pcre2_general_context_create</span><span style="color: #d4d4d4;">(</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; pcre2_malloc, pcre2_free, </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"Couldn't allocate PCRE2 general context"</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_case</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_locale</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #dcdcaa;">has_non_ascii</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_tables</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">pcre2_maketables</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_compile_context</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">pcre2_compile_context_create</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">pcre2_set_character_tables</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_compile_context</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_tables</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; options |= PCRE2_CASELESS;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_locale</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #dcdcaa;">is_utf8_locale</span><span style="color: #d4d4d4;">() &amp;&amp; !literal)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; options |= (PCRE2_UTF | PCRE2_MATCH_INVALID_UTF);</span></div>
      <br>
      <div><span style="color: #c586c0;">#ifdef</span><span style="color: #569cd6;"> GIT_PCRE2_VERSION_10_36_OR_HIGHER</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* Work around https://bugs.exim.org/show_bug.cgi?id=2642 fixed in 10.36 */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (PCRE2_MATCH_INVALID_UTF &amp;&amp; options &amp; (PCRE2_UTF | PCRE2_CASELESS))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; options |= PCRE2_NO_START_OPTIMIZE;</span></div>
      <div><span style="color: #c586c0;">#endif</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">pcre2_compile</span><span style="color: #d4d4d4;">((PCRE2_SPTR)</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">, options, &amp;error, &amp;erroffset,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_compile_context</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_match_data</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">pcre2_match_data_create_from_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_match_data</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"Couldn't allocate PCRE2 match data"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; } </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">pcre2_get_error_message</span><span style="color: #d4d4d4;">(error, errbuf, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(errbuf));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_regexp_failed</span><span style="color: #d4d4d4;">(p, (</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *)&amp;errbuf);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">pcre2_config</span><span style="color: #d4d4d4;">(PCRE2_CONFIG_JIT, &amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_jit_on</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_jit_on</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; jitret = </span><span style="color: #dcdcaa;">pcre2_jit_compile</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">, PCRE2_JIT_COMPLETE);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (jitret)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"Couldn't JIT the PCRE2 pattern '</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">', got '</span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, jitret);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* The pcre2_config(PCRE2_CONFIG_JIT, ...) call just</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* tells us whether the library itself supports JIT,</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* but to see whether we're going to be actually using</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* JIT we need to extract PCRE2_INFO_JITSIZE from the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* pattern *after* we do pcre2_jit_compile() above.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* This is because if the pattern contains the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* (*NO_JIT) verb (see pcre2syntax(3))</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* pcre2_jit_compile() will exit early with 0. If we</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* then proceed to call pcre2_jit_match() further down</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* the line instead of pcre2_match() we'll either</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* segfault (pre PCRE 10.31) or run into a fatal error</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* (post PCRE2 10.31)</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; patinforet = </span><span style="color: #dcdcaa;">pcre2_pattern_info</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">, PCRE2_INFO_JITSIZE, &amp;jitsizearg);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (patinforet)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pcre2_pattern_info() failed: </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, patinforet);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (jitsizearg == </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_jit_on</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">pcre2match</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">line</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> ret, flags = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; PCRE2_SIZE *ovector;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; PCRE2_UCHAR </span><span style="color: #9cdcfe;">errbuf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">256</span><span style="color: #d4d4d4;">];</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (eflags &amp; REG_NOTBOL)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; flags |= PCRE2_NOTBOL;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_jit_on</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ret = </span><span style="color: #dcdcaa;">pcre2_jit_match</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">, (</span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *)line,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol - line, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, flags, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_match_data</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ret = </span><span style="color: #dcdcaa;">pcre2_match</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">, (</span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *)line,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol - line, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, flags, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_match_data</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (ret &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> &amp;&amp; ret != PCRE2_ERROR_NOMATCH) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">pcre2_get_error_message</span><span style="color: #d4d4d4;">(ret, errbuf, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(errbuf));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;"> failed with error code </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">: </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_jit_on</span><span style="color: #d4d4d4;"> ? </span><span style="color: #ce9178;">"pcre2_jit_match"</span><span style="color: #d4d4d4;"> : </span><span style="color: #ce9178;">"pcre2_match"</span><span style="color: #d4d4d4;">), ret,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; errbuf);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (ret &gt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ovector = </span><span style="color: #dcdcaa;">pcre2_get_ovector_pointer</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_match_data</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ret = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> = (</span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;">)</span><span style="color: #9cdcfe;">ovector</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> = (</span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;">)</span><span style="color: #9cdcfe;">ovector</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> ret;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">free_pcre2_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">pcre2_compile_context_free</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_compile_context</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">pcre2_code_free</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">pcre2_match_data_free</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_match_data</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #c586c0;">#ifdef</span><span style="color: #569cd6;"> GIT_PCRE2_VERSION_10_34_OR_HIGHER</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">pcre2_maketables_free</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_tables</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #c586c0;">#else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">((</span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *)</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_tables</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #c586c0;">#endif</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">pcre2_general_context_free</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_general_context</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <div><span style="color: #c586c0;">#else</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_pcre2_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"cannot use Perl-compatible regexes when not compiled with USE_LIBPCRE"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">pcre2match</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">line</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">free_pcre2_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_fixed_regexp</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> strbuf sb = STRBUF_INIT;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> err;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> regflags = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">basic_regex_quote_buf</span><span style="color: #d4d4d4;">(&amp;sb, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_case</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; regflags |= REG_ICASE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; err = </span><span style="color: #dcdcaa;">regcomp</span><span style="color: #d4d4d4;">(&amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">regexp</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">sb</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">, regflags);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">strbuf_release</span><span style="color: #d4d4d4;">(&amp;sb);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (err) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">errbuf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">1024</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">regerror</span><span style="color: #d4d4d4;">(err, &amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">regexp</span><span style="color: #d4d4d4;">, errbuf, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(errbuf));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_regexp_failed</span><span style="color: #d4d4d4;">(p, errbuf);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <div><span style="color: #c586c0;">#endif</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">/* !USE_LIBPCRE2 */</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_regexp</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> err;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> regflags = REG_NEWLINE;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">word_regexp</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">word_regexp</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_case</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_case</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">fixed</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">fixed</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">memchr</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">) &amp;&amp; !</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #dcdcaa;">_</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"given pattern contains NULL byte (via -f &lt;file&gt;). This is only supported with -P under PCRE v2"</span><span style="color: #d4d4d4;">));</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">is_fixed</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">is_fixed</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #c586c0;">#ifdef</span><span style="color: #569cd6;"> USE_LIBPCRE2</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160;</span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">fixed</span><span style="color: #d4d4d4;"> &amp;&amp; !</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">is_fixed</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *no_jit = </span><span style="color: #ce9178;">"(*NO_JIT)"</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> no_jit_len = </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(no_jit);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">starts_with</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, no_jit) &amp;&amp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #dcdcaa;">is_fixed</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;"> + no_jit_len,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;"> - no_jit_len))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">is_fixed</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160;}</span></div>
      <div><span style="color: #c586c0;">#endif</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">fixed</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">is_fixed</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #c586c0;">#ifdef</span><span style="color: #569cd6;"> USE_LIBPCRE2</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">is_fixed</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_pcre2_pattern</span><span style="color: #d4d4d4;">(p, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; } </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* E.g. t7811-grep-open.sh relies on the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* pattern being restored.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *old_pattern = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> old_patternlen = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> strbuf sb = STRBUF_INIT;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* There is the PCRE2_LITERAL flag, but it's</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* only in PCRE v2 10.30 and later. Needing to</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* ifdef our way around that and dealing with</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* it + PCRE2_MULTILINE being an error is more</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* complex than just quoting this ourselves.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">strbuf_add</span><span style="color: #d4d4d4;">(&amp;sb, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\\</span><span style="color: #ce9178;">Q"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">strbuf_add</span><span style="color: #d4d4d4;">(&amp;sb, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">strbuf_add</span><span style="color: #d4d4d4;">(&amp;sb, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\\</span><span style="color: #ce9178;">E"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">sb</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">sb</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">len</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_pcre2_pattern</span><span style="color: #d4d4d4;">(p, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;"> = old_pattern;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">patternlen</span><span style="color: #d4d4d4;"> = old_patternlen;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">strbuf_release</span><span style="color: #d4d4d4;">(&amp;sb);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #c586c0;">#else</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_fixed_regexp</span><span style="color: #d4d4d4;">(p, opt);</span></div>
      <div><span style="color: #c586c0;">#endif</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">/* !USE_LIBPCRE2 */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_pcre2_pattern</span><span style="color: #d4d4d4;">(p, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">ignore_case</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; regflags |= REG_ICASE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended_regexp_option</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; regflags |= REG_EXTENDED;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; err = </span><span style="color: #dcdcaa;">regcomp</span><span style="color: #d4d4d4;">(&amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">regexp</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, regflags);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (err) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">errbuf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">1024</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">regerror</span><span style="color: #d4d4d4;">(err, &amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">regexp</span><span style="color: #d4d4d4;">, errbuf, </span><span style="color: #b5cea8;">1024</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_regexp_failed</span><span style="color: #d4d4d4;">(p, errbuf);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">grep_not_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">expr</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *z = </span><span style="color: #dcdcaa;">xcalloc</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(*z));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> = GREP_NODE_NOT;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">unary</span><span style="color: #d4d4d4;"> = expr;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> z;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">grep_binexp</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_expr_node </span><span style="color: #9cdcfe;">kind</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *z = </span><span style="color: #dcdcaa;">xcalloc</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(*z));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> = kind;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;"> = left;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;"> = right;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> z;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">grep_or_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_binexp</span><span style="color: #d4d4d4;">(GREP_NODE_OR, left, right);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">grep_and_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_binexp</span><span style="color: #d4d4d4;">(GREP_NODE_AND, left, right);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">compile_pattern_or</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat **);</span></div>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">compile_pattern_atom</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat **</span><span style="color: #9cdcfe;">list</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *x;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!p)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN: </span><span style="color: #6a9955;">/* atom */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">CALLOC_ARRAY</span><span style="color: #d4d4d4;">(x, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> = GREP_NODE_ATOM;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">atom</span><span style="color: #d4d4d4;"> = p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *list = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> x;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_OPEN_PAREN:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *list = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = </span><span style="color: #dcdcaa;">compile_pattern_or</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!*list || (*list)-&gt;token != GREP_CLOSE_PAREN)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"unmatched parenthesis"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *list = (*list)-&gt;next;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> x;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">compile_pattern_not</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat **</span><span style="color: #9cdcfe;">list</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *x;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!p)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NOT:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!p-&gt;next)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"--not not followed by pattern expression"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *list = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = </span><span style="color: #dcdcaa;">compile_pattern_not</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!x)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"--not followed by non pattern expression"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_not_expr</span><span style="color: #d4d4d4;">(x);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_pattern_atom</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">compile_pattern_and</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat **</span><span style="color: #9cdcfe;">list</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *x, *y;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; x = </span><span style="color: #dcdcaa;">compile_pattern_not</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (p &amp;&amp; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> == GREP_AND) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!x)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"--and not preceded by pattern expression"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"--and not followed by pattern expression"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *list = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; y = </span><span style="color: #dcdcaa;">compile_pattern_and</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!y)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"--and not followed by pattern expression"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_and_expr</span><span style="color: #d4d4d4;">(x, y);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> x;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">compile_pattern_or</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat **</span><span style="color: #9cdcfe;">list</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *x, *y;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; x = </span><span style="color: #dcdcaa;">compile_pattern_and</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; p = *list;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (x &amp;&amp; p &amp;&amp; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> != GREP_CLOSE_PAREN) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; y = </span><span style="color: #dcdcaa;">compile_pattern_or</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!y)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"not a pattern expression </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_or_expr</span><span style="color: #d4d4d4;">(x, y);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> x;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">compile_pattern_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat **</span><span style="color: #9cdcfe;">list</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_pattern_or</span><span style="color: #d4d4d4;">(list);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">grep_true_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *z = </span><span style="color: #dcdcaa;">xcalloc</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(*z));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> = GREP_NODE_TRUE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> z;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">prep_header_patterns</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *header_expr;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *(</span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[GREP_HEADER_FIELD_MAX]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_header_field fld;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_list</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_list</span><span style="color: #d4d4d4;">; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> != GREP_PATTERN_HEAD)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"a non-header pattern in grep header list."</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;"> &lt; GREP_HEADER_FIELD_MIN ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; GREP_HEADER_FIELD_MAX &lt;= </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"unknown header field </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_regexp</span><span style="color: #d4d4d4;">(p, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (fld = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; fld &lt; GREP_HEADER_FIELD_MAX; fld++)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[fld] = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_list</span><span style="color: #d4d4d4;">; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *h;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *pp = p;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; h = </span><span style="color: #dcdcaa;">compile_pattern_atom</span><span style="color: #d4d4d4;">(&amp;pp);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!h || pp != </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"malformed header expr"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">]) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">] = h;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">continue</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">] = </span><span style="color: #dcdcaa;">grep_or_expr</span><span style="color: #d4d4d4;">(h, </span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; header_expr = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (fld = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; fld &lt; GREP_HEADER_FIELD_MAX; fld++) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[fld])</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">continue</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!header_expr)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; header_expr = </span><span style="color: #dcdcaa;">grep_true_expr</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; header_expr = </span><span style="color: #dcdcaa;">grep_or_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">header_group</span><span style="color: #d4d4d4;">[fld], header_expr);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> header_expr;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #dcdcaa;">grep_splice_or</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">y</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *z = x;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (x) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">assert</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> == GREP_NODE_OR);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;"> &amp;&amp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> == GREP_NODE_TRUE) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;"> = y;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> z;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">compile_grep_patterns</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *header_expr = </span><span style="color: #dcdcaa;">prep_header_patterns</span><span style="color: #d4d4d4;">(opt);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN: </span><span style="color: #6a9955;">/* atom */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">compile_regexp</span><span style="color: #d4d4d4;">(p, opt);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">all_match</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no_body_match</span><span style="color: #d4d4d4;"> || header_expr)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (p)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">compile_pattern_expr</span><span style="color: #d4d4d4;">(&amp;p);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (p)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"incomplete pattern expression: </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no_body_match</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">grep_not_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!header_expr)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;"> = header_expr;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">all_match</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">grep_splice_or</span><span style="color: #d4d4d4;">(header_expr,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">grep_or_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;header_expr);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">all_match</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">free_pattern_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_TRUE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_ATOM:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_NOT:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free_pattern_expr</span><span style="color: #d4d4d4;">(x-&gt;u.unary);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_AND:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_OR:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free_pattern_expr</span><span style="color: #d4d4d4;">(x-&gt;u.binary.left);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free_pattern_expr</span><span style="color: #d4d4d4;">(x-&gt;u.binary.right);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">(x);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">free_grep_patterns</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p, *n;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">; p; p = n) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; n = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN: </span><span style="color: #6a9955;">/* atom */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (p-&gt;pcre2_pattern)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free_pcre2_pattern</span><span style="color: #d4d4d4;">(p);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">regfree</span><span style="color: #d4d4d4;">(&amp;p-&gt;</span><span style="color: #9cdcfe;">regexp</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">(p-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">(p);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">free_pattern_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #dcdcaa;">end_of_line</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">cp</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> l = *left;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (l &amp;&amp; *cp != </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; l--;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; cp++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *left = l;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> cp;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">word_char</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">ch</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">isalnum</span><span style="color: #d4d4d4;">(ch) || ch == </span><span style="color: #ce9178;">'_'</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">data</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">want_color</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;">) &amp;&amp; color &amp;&amp; </span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">]) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, color, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(color));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, data, size);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, GIT_COLOR_RESET, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(GIT_COLOR_RESET));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; } </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, data, size);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">output_sep</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">sign</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">null_following_name</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\0</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, &amp;sign, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">show_name</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, name, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(name), </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">null_following_name</span><span style="color: #d4d4d4;"> ? </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\0</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;"> : </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">patmatch</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">line</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> hit;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pcre2_pattern</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; hit = !</span><span style="color: #dcdcaa;">pcre2match</span><span style="color: #d4d4d4;">(p, line, eol, match, eflags);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; hit = !</span><span style="color: #dcdcaa;">regexec_buf</span><span style="color: #d4d4d4;">(&amp;</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">regexp</span><span style="color: #d4d4d4;">, line, eol - line, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, match,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;eflags);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> hit;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">strip_timestamp</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> **</span><span style="color: #9cdcfe;">eol_p</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *eol = *eol_p;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (bol &lt; --eol) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (*eol != </span><span style="color: #ce9178;">'&gt;'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">continue</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *eol_p = ++eol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *field;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> len;</span></div>
      <div><span style="color: #d4d4d4;">} header_field</span><span style="color: #569cd6;">[]</span><span style="color: #d4d4d4;"> = {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; { </span><span style="color: #ce9178;">"author "</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">7</span><span style="color: #d4d4d4;"> },</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; { </span><span style="color: #ce9178;">"committer "</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">10</span><span style="color: #d4d4d4;"> },</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; { </span><span style="color: #ce9178;">"reflog "</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">7</span><span style="color: #d4d4d4;"> },</span></div>
      <div><span style="color: #d4d4d4;">};</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">headerless_match_one_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> hit = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *start = bol;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> ((</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> != GREP_PATTERN) &amp;&amp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ((</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> == GREP_PATTERN_HEAD) != (ctx == GREP_CONTEXT_HEAD)))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160;again:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; hit = </span><span style="color: #dcdcaa;">patmatch</span><span style="color: #d4d4d4;">(p, bol, eol, pmatch, eflags);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (hit &amp;&amp; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">word_regexp</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> ((</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; (eol - bol) &lt; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; (</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; (eol - bol) &lt; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"regexp returned nonsense"</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* Match beginning must be either beginning of the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* line, or at word boundary (i.e. the last char must</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* not be a word char). &#160;Similarly, match end must be</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* either end of the line, or at word boundary</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* (i.e. the next char must not be a word char).</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> ( ((</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> == </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; !</span><span style="color: #dcdcaa;">word_char</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">-</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">])) &amp;&amp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;((</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> == (eol-bol)) ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; !</span><span style="color: #dcdcaa;">word_char</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">])) )</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; ;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; hit = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* Words consist of at least one character. */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> == </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; hit = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!hit &amp;&amp; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> + bol + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;"> &lt; eol) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* There could be more than one match on the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* line, and the first match might not be</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* strict word match. &#160;But later ones could be!</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Forward to the next possible start, i.e. the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* next position following a non-word char.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; bol = </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> + bol + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">word_char</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">[-</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">]) &amp;&amp; bol &lt; eol)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; bol++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; eflags |= REG_NOTBOL;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (bol &lt; eol)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">goto</span><span style="color: #d4d4d4;"> again;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (hit) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> += bol - start;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> += bol - start;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> hit;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_one_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">, </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *field;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> len;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> == GREP_PATTERN_HEAD) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">assert</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #dcdcaa;">ARRAY_SIZE</span><span style="color: #d4d4d4;">(header_field));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; field = </span><span style="color: #9cdcfe;">header_field</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; len = </span><span style="color: #9cdcfe;">header_field</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">].</span><span style="color: #9cdcfe;">len</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">strncmp</span><span style="color: #d4d4d4;">(bol, field, len))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; bol += len;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_HEADER_AUTHOR:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_HEADER_COMMITTER:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">strip_timestamp</span><span style="color: #d4d4d4;">(bol, &amp;</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">headerless_match_one_pattern</span><span style="color: #d4d4d4;">(p, bol, eol, ctx, pmatch, eflags);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">col</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">icol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">collect_hits</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> h = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!x)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"Not a valid grep expression"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_TRUE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; h = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_ATOM:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> tmp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; h = </span><span style="color: #dcdcaa;">match_one_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">atom</span><span style="color: #d4d4d4;">, bol, eol, ctx,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &amp;tmp, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (h &amp;&amp; (*col &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">tmp</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &lt; *col))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; *col = </span><span style="color: #9cdcfe;">tmp</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (x-&gt;u.atom-&gt;token == GREP_PATTERN_BODY)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">body_hit</span><span style="color: #d4d4d4;"> |= h;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_NOT:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* Upon visiting a GREP_NODE_NOT, col and icol become swapped.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; h = !</span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, x-&gt;u.unary, bol, eol, ctx, icol, col,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_AND:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; h = </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, x-&gt;u.binary.left, bol, eol, ctx, col,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; icol, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (h || opt-&gt;columnnum) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Don't short-circuit AND when given --column, since a</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* NOT earlier in the tree may turn this into an OR. In</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* this case, see the below comment.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; h &amp;= </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">, bol, eol,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ctx, col, icol, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_NODE_OR:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!(collect_hits || opt-&gt;columnnum)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Don't short-circuit OR when given --column (or</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* collecting hits) to ensure we don't skip a later</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* child that would produce an earlier match.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">, bol, eol,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ctx, col, icol, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">, bol,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; eol, ctx, col, icol, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; h = </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, x-&gt;u.binary.left, bol, eol, ctx, col,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; icol, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (collect_hits)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">hit</span><span style="color: #d4d4d4;"> |= h;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; h |= </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, x-&gt;u.binary.right, bol, eol, ctx, col,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;icol, collect_hits);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">die</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"Unexpected node type (internal error) </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, x-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (collect_hits)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">hit</span><span style="color: #d4d4d4;"> |= h;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> h;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_expr</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">col</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">icol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">collect_hits</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *x = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_expr_eval</span><span style="color: #d4d4d4;">(opt, x, bol, eol, ctx, col, icol, collect_hits);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_line</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">col</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">icol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">collect_hits</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> hit = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_expr</span><span style="color: #d4d4d4;">(opt, bol, eol, ctx, col, icol,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; collect_hits);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* we do not call with collect_hits without being extended */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> tmp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">match_one_pattern</span><span style="color: #d4d4d4;">(p, bol, eol, ctx, &amp;tmp, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; hit |= </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">columnnum</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* Without --column, any single match on a line</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* is enough to know that it needs to be</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* printed. With --column, scan _all_ patterns</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* to find the earliest.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (*col &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">tmp</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &lt; *col)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; *col = </span><span style="color: #9cdcfe;">tmp</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> hit;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_next_pattern</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> match;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">headerless_match_one_pattern</span><span style="color: #d4d4d4;">(p, bol, eol, ctx, &amp;match, eflags))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &gt;= </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> &gt;= </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &gt; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> == </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_next_match</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context </span><span style="color: #9cdcfe;">ctx</span><span style="color: #d4d4d4;">, </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_header_field </span><span style="color: #9cdcfe;">field</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">eflags</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> hit = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">pmatch</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> = -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (bol &lt; eol) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = ((ctx == GREP_CONTEXT_HEAD)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;? </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">header_list</span><span style="color: #d4d4d4;"> : </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_HEAD:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> ((field != GREP_HEADER_FIELD_MAX) &amp;&amp;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (p-&gt;field != field))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">continue</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* fall thru */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN: </span><span style="color: #6a9955;">/* atom */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_PATTERN_BODY:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; hit |= </span><span style="color: #dcdcaa;">match_next_pattern</span><span style="color: #d4d4d4;">(p, bol, eol, ctx,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pmatch, eflags);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> hit;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">show_line_header</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">lno</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">cno</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">sign</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">heading</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> == </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, name, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(name), </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> = lno;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">heading</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pathname</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, name, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(name), </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_sep</span><span style="color: #d4d4d4;">(opt, sign);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">linenum</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">32</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">xsnprintf</span><span style="color: #d4d4d4;">(buf, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(buf), </span><span style="color: #ce9178;">"</span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, lno);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, buf, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(buf), </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_LINENO]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_sep</span><span style="color: #d4d4d4;">(opt, sign);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* Treat 'cno' as the 1-indexed offset from the start of a non-context</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* line to its first match. Otherwise, 'cno' is 0 indicating that we are</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* being called with a context line.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">columnnum</span><span style="color: #d4d4d4;"> &amp;&amp; cno) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">32</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">xsnprintf</span><span style="color: #d4d4d4;">(buf, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(buf), </span><span style="color: #ce9178;">"%"</span><span style="color: #d4d4d4;">PRIuMAX, (</span><span style="color: #569cd6;">uintmax_t</span><span style="color: #d4d4d4;">)cno);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, buf, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(buf), </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_COLUMNNO]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_sep</span><span style="color: #d4d4d4;">(opt, sign);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">show_line</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">lno</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">cno</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">sign</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> rest = eol - bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *match_color = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *line_color = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">file_break</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> == </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">show_hunk_mark</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; } </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pre_context</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">post_context</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcbody</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> == </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">show_hunk_mark</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"--"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; } </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (lno &gt; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"--"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_SEP]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">only_matching</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* In case the line we're being called with contains more than</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* one match, leave printing each header to the loop below.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_line_header</span><span style="color: #d4d4d4;">(opt, name, lno, cno, sign);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">only_matching</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> match;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context ctx = GREP_CONTEXT_BODY;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> eflags = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (sign == </span><span style="color: #ce9178;">':'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; match_color = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_MATCH_SELECTED];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; match_color = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_MATCH_CONTEXT];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (sign == </span><span style="color: #ce9178;">':'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; line_color = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_SELECTED];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (sign == </span><span style="color: #ce9178;">'-'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; line_color = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_CONTEXT];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (sign == </span><span style="color: #ce9178;">'='</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; line_color = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_FUNCTION];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">grep_next_match</span><span style="color: #d4d4d4;">(opt, bol, eol, ctx, &amp;match,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GREP_HEADER_FIELD_MAX, eflags)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> == </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">only_matching</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_line_header</span><span style="color: #d4d4d4;">(opt, name, lno, cno, sign);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, bol, </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">, line_color);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, bol + </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> - </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">, match_color);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">only_matching</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; bol += </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; cno += </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; rest -= </span><span style="color: #9cdcfe;">match</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; eflags = REG_NOTBOL;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">only_matching</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, bol, rest, line_color);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> grep_use_locks;</span></div>
      <br>
      <div><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160;* This lock protects access to the gitattributes machinery, which is</span></div>
      <div><span style="color: #6a9955;">&#160;* not thread-safe.</span></div>
      <div><span style="color: #6a9955;">&#160;*/</span></div>
      <div><span style="color: #569cd6;">pthread_mutex_t</span><span style="color: #d4d4d4;"> grep_attr_mutex;</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">inline</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_attr_lock</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (grep_use_locks)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">pthread_mutex_lock</span><span style="color: #d4d4d4;">(&amp;grep_attr_mutex);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">inline</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_attr_unlock</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (grep_use_locks)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">pthread_mutex_unlock</span><span style="color: #d4d4d4;">(&amp;grep_attr_mutex);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">match_funcname</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #4ec9b0;">xdemitconf_t</span><span style="color: #d4d4d4;"> *xecfg = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">priv</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (xecfg &amp;&amp; !</span><span style="color: #9cdcfe;">xecfg</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">find_func</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_source_load_driver</span><span style="color: #d4d4d4;">(gs, </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">index</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcname</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> userdiff_funcname *pe = &amp;</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcname</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">xdiff_set_find_func</span><span style="color: #d4d4d4;">(xecfg, </span><span style="color: #9cdcfe;">pe</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">pe</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">cflags</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; } </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; xecfg = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">priv</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (xecfg) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">xecfg</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">find_func</span><span style="color: #d4d4d4;">(bol, eol - bol, buf, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">xecfg</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">find_func_priv</span><span style="color: #d4d4d4;">) &gt;= </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (bol == eol)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">isalpha</span><span style="color: #d4d4d4;">(*bol) || *bol == </span><span style="color: #ce9178;">'_'</span><span style="color: #d4d4d4;"> || *bol == </span><span style="color: #ce9178;">'$'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">show_funcname_line</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">lno</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (bol &gt; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *eol = --bol;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (bol &gt; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">[-</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">] != </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; bol--;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; lno--;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (lno &lt;= </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">match_funcname</span><span style="color: #d4d4d4;">(opt, gs, bol, eol)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_line</span><span style="color: #d4d4d4;">(opt, bol, eol, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, lno, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">'='</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">is_empty_line</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">show_pre_context</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">end</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">lno</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> cur = lno, from = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, funcname_lno = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, orig_from;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> funcname_needed = !!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcname</span><span style="color: #d4d4d4;">, comment_needed = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pre_context</span><span style="color: #d4d4d4;"> &lt; lno)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; from = lno - </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pre_context</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (from &lt;= </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; from = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; orig_from = from;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcbody</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">match_funcname</span><span style="color: #d4d4d4;">(opt, gs, bol, end))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; comment_needed = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; funcname_needed = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; from = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* Rewind. */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (bol &gt; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> &amp;&amp; cur &gt; from) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *next_bol = bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *eol = --bol;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (bol &gt; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">[-</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">] != </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; bol--;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; cur--;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (comment_needed &amp;&amp; (</span><span style="color: #dcdcaa;">is_empty_line</span><span style="color: #d4d4d4;">(bol, eol) ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #dcdcaa;">match_funcname</span><span style="color: #d4d4d4;">(opt, gs, bol, eol))) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; comment_needed = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; from = orig_from;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (cur &lt; from) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; cur++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; bol = next_bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (funcname_needed &amp;&amp; </span><span style="color: #dcdcaa;">match_funcname</span><span style="color: #d4d4d4;">(opt, gs, bol, eol)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; funcname_lno = cur;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; funcname_needed = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcbody</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; comment_needed = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; from = orig_from;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* We need to look even further back to find a function signature. */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcname</span><span style="color: #d4d4d4;"> &amp;&amp; funcname_needed)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_funcname_line</span><span style="color: #d4d4d4;">(opt, gs, bol, cur);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* Back forward. */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (cur &lt; lno) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *eol = bol, sign = (cur == funcname_lno) ? </span><span style="color: #ce9178;">'='</span><span style="color: #d4d4d4;"> : </span><span style="color: #ce9178;">'-'</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (*eol != </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; eol++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_line</span><span style="color: #d4d4d4;">(opt, bol, eol, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, cur, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, sign);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; bol = eol + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; cur++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">should_lookahead</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">extended</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; </span><span style="color: #6a9955;">/* punt for too complex stuff */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">invert</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">token</span><span style="color: #d4d4d4;"> != GREP_PATTERN)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; </span><span style="color: #6a9955;">/* punt for "header only" and stuff */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">look_ahead</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">left_p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">lno_p</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> **</span><span style="color: #9cdcfe;">bol_p</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> lno = *lno_p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *bol = *bol_p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_pat *p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *sp, *last_bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #4ec9b0;">regoff_t</span><span style="color: #d4d4d4;"> earliest = -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (p = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_list</span><span style="color: #d4d4d4;">; p; p = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">next</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> hit;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">regmatch_t</span><span style="color: #d4d4d4;"> m;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; hit = </span><span style="color: #dcdcaa;">patmatch</span><span style="color: #d4d4d4;">(p, bol, bol + *left_p, &amp;m, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!hit || </span><span style="color: #9cdcfe;">m</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">m</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_eo</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">continue</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (earliest &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">m</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;"> &lt; earliest)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; earliest = </span><span style="color: #9cdcfe;">m</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rm_so</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (earliest &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *bol_p = bol + *left_p;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; *left_p = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (sp = bol + earliest; bol &lt; sp &amp;&amp; </span><span style="color: #9cdcfe;">sp</span><span style="color: #d4d4d4;">[-</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">] != </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">; sp--)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ; </span><span style="color: #6a9955;">/* find the beginning of the line */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; last_bol = sp;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (sp = bol; sp &lt; last_bol; sp++) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (*sp == </span><span style="color: #ce9178;">'</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">'</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; lno++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *left_p -= last_bol - bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *bol_p = last_bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; *lno_p = lno;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">fill_textconv_grep</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> repository *</span><span style="color: #9cdcfe;">r</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> userdiff_driver *</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> diff_filespec *df;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *buf;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> size;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!driver || !</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">textconv</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load</span><span style="color: #d4d4d4;">(gs);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* The textconv interface is intimately tied to diff_filespecs, so we</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* have to pretend to be one. If we could unify the grep_source</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* and diff_filespec structs, this mess could just go away.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; df = </span><span style="color: #dcdcaa;">alloc_filespec</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">fill_filespec</span><span style="color: #d4d4d4;">(df, gs-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">0100644</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">fill_filespec</span><span style="color: #d4d4d4;">(df, </span><span style="color: #dcdcaa;">null_oid</span><span style="color: #d4d4d4;">(), </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">0100644</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"attempt to textconv something without a path?"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* fill_textconv is not remotely thread-safe; it modifies the global</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* diff tempfile structure, writes to the_repo's odb and might</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* internally call thread-unsafe functions such as the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* prepare_packed_git() lazy-initializator. Because of the last two, we</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* must ensure mutual exclusion between this call and the object reading</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* API, thus we use obj_read_lock() here.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* TODO: allowing text conversion to run in parallel with object</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* reading operations might increase performance in the multithreaded</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* non-worktreee git-grep with --textconv.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">obj_read_lock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; size = </span><span style="color: #dcdcaa;">fill_textconv</span><span style="color: #d4d4d4;">(r, driver, df, &amp;buf);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">obj_read_unlock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">free_filespec</span><span style="color: #d4d4d4;">(df);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* The normal fill_textconv usage by the diff machinery would just keep</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* the textconv'd buf separate from the diff_filespec. But much of the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* grep code passes around a grep_source and assumes that its "buf"</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* pointer is the beginning of the thing we are searching. So let's</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* install our textconv'd version into the grep_source, taking care not</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* to leak any existing buffer.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_source_clear_data</span><span style="color: #d4d4d4;">(gs);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = buf;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;"> = size;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">is_empty_line</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">bol</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">eol</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (bol &lt; eol &amp;&amp; </span><span style="color: #dcdcaa;">isspace</span><span style="color: #d4d4d4;">(*bol))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; bol++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> bol == eol;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_1</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">collect_hits</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *peek_bol = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> left;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> lno = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> last_hit = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> binary_match_only = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> count = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> try_lookahead = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> show_function = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> userdiff_driver *textconv = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> grep_context ctx = GREP_CONTEXT_HEAD;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #4ec9b0;">xdemitconf_t</span><span style="color: #d4d4d4;"> xecfg;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">status_only</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;"> == </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"grep call which could print a name requires "</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #ce9178;">"grep_source.name be non-NULL"</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">output</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">output</span><span style="color: #d4d4d4;"> = std_output;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pre_context</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">post_context</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">file_break</span><span style="color: #d4d4d4;"> ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcbody</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* Show hunk marks, except for the first file. */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">show_hunk_mark</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* If we're using threads then we can't easily identify</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* the first file. &#160;Always put hunk marks in that case</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* and skip the very first one later in work_done().</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">output</span><span style="color: #d4d4d4;"> != std_output)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">show_hunk_mark</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">last_shown</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">allow_textconv</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_source_load_driver</span><span style="color: #d4d4d4;">(gs, </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">index</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* We might set up the shared textconv cache data here, which</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* is not thread-safe. Also, get_oid_with_context() and</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* parse_object() might be internally called. As they are not</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* currently thread-safe and might be racy with object reading,</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* obj_read_lock() must be called.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_attr_lock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">obj_read_lock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; textconv = </span><span style="color: #dcdcaa;">userdiff_get_textconv</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">obj_read_unlock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">grep_attr_unlock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* We know the result of a textconv is text, so we only have to care</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* about binary handling if we are not using it.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!textconv) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_BINARY_DEFAULT:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">grep_source_is_binary</span><span style="color: #d4d4d4;">(gs, opt-&gt;repo-&gt;</span><span style="color: #9cdcfe;">index</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; binary_match_only = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_BINARY_NOMATCH:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">grep_source_is_binary</span><span style="color: #d4d4d4;">(gs, opt-&gt;repo-&gt;</span><span style="color: #9cdcfe;">index</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; </span><span style="color: #6a9955;">/* Assume unmatch */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_BINARY_TEXT:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"unknown binary handling mode"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">memset</span><span style="color: #d4d4d4;">(&amp;xecfg, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(xecfg));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">priv</span><span style="color: #d4d4d4;"> = &amp;xecfg;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; try_lookahead = </span><span style="color: #dcdcaa;">should_lookahead</span><span style="color: #d4d4d4;">(opt);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">fill_textconv_grep</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">, textconv, gs) &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; bol = </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; left = </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (left) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *eol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> hit;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> cno;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">ssize_t</span><span style="color: #d4d4d4;"> col = -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, icol = -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* look_ahead() skips quickly to the line that possibly</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* has the next hit; don't call it if we need to do</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* something more than just skipping the current line</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* in response to an unmatch for the current line. &#160;E.g.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* inside a post-context window, we will show the current</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* line as a context around the previous hit when it</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* doesn't hit.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (try_lookahead</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &amp;&amp; !(last_hit</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;&amp;&amp; (show_function ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;lno &lt;= last_hit + </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">post_context</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &amp;&amp; </span><span style="color: #dcdcaa;">look_ahead</span><span style="color: #d4d4d4;">(opt, &amp;left, &amp;lno, &amp;bol))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; eol = </span><span style="color: #dcdcaa;">end_of_line</span><span style="color: #d4d4d4;">(bol, &amp;left);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> ((ctx == GREP_CONTEXT_HEAD) &amp;&amp; (eol == bol))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; ctx = GREP_CONTEXT_BODY;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; hit = </span><span style="color: #dcdcaa;">match_line</span><span style="color: #d4d4d4;">(opt, bol, eol, &amp;col, &amp;icol, ctx, collect_hits);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (collect_hits)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">goto</span><span style="color: #d4d4d4;"> next_line;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* "grep -v -e foo -e bla" should list lines</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* that do not have either, so inversion should</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;* be done outside.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">invert</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; hit = !hit;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">unmatch_name_only</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (hit)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">goto</span><span style="color: #d4d4d4;"> next_line;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (hit) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; count++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">status_only</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name_only</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_name</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">count</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">goto</span><span style="color: #d4d4d4;"> next_line;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (binary_match_only) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">"Binary file "</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">12</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">),</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">" matches</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">9</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* Hit at this line. &#160;If we haven't shown the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* pre-context lines, we would need to show them.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pre_context</span><span style="color: #d4d4d4;"> || </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcbody</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_pre_context</span><span style="color: #d4d4d4;">(opt, gs, bol, eol, lno);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcname</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_funcname_line</span><span style="color: #d4d4d4;">(opt, gs, bol, lno);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; cno = </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">invert</span><span style="color: #d4d4d4;"> ? icol : col;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (cno &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* A negative cno indicates that there was no</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* match on the line. We are thus inverted and</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* being asked to show all lines that _don't_</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* match a given expression. Therefore, set cno</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* to 0 to suggest the whole line matches.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; cno = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_line</span><span style="color: #d4d4d4;">(opt, bol, eol, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, lno, cno + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">':'</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; last_hit = lno;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">funcbody</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_function = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">goto</span><span style="color: #d4d4d4;"> next_line;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (show_function &amp;&amp; (!peek_bol || peek_bol &lt; bol)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> peek_left = left;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *peek_eol = eol;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Trailing empty lines are not interesting.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* Peek past them to see if they belong to the</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* body of the current function.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; peek_bol = bol;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">is_empty_line</span><span style="color: #d4d4d4;">(peek_bol, peek_eol)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; peek_bol = peek_eol + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; peek_eol = </span><span style="color: #dcdcaa;">end_of_line</span><span style="color: #d4d4d4;">(peek_bol, &amp;peek_left);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">match_funcname</span><span style="color: #d4d4d4;">(opt, gs, peek_bol, peek_eol))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; show_function = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (show_function ||</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; (last_hit &amp;&amp; lno &lt;= last_hit + </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">post_context</span><span style="color: #d4d4d4;">)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* If the last hit is within the post context,</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;* we need to show this line.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160; &#160; &#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_line</span><span style="color: #d4d4d4;">(opt, bol, eol, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, lno, col + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">'-'</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; next_line:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; bol = eol + </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!left)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; left--;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; lno++;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (collect_hits)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">status_only</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">unmatch_name_only</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">unmatch_name_only</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* We did not see any hit, so we want to show this */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">show_name</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">xdiff_clear_find_func</span><span style="color: #d4d4d4;">(&amp;xecfg);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">priv</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* NEEDSWORK:</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* The real "grep -c foo *.c" gives many "bar.c:0" lines,</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* which feels mostly useless but sometimes useful. &#160;Maybe</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* make it another option? &#160;For now suppress them.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">count</span><span style="color: #d4d4d4;"> &amp;&amp; count) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">[</span><span style="color: #b5cea8;">32</span><span style="color: #d4d4d4;">];</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pathname</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_color</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">),</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">colors</span><span style="color: #d4d4d4;">[GREP_COLOR_FILENAME]);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">output_sep</span><span style="color: #d4d4d4;">(opt, </span><span style="color: #ce9178;">':'</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">xsnprintf</span><span style="color: #d4d4d4;">(buf, </span><span style="color: #569cd6;">sizeof</span><span style="color: #d4d4d4;">(buf), </span><span style="color: #ce9178;">"</span><span style="color: #9cdcfe;">%u</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">, count);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">output</span><span style="color: #d4d4d4;">(opt, buf, </span><span style="color: #dcdcaa;">strlen</span><span style="color: #d4d4d4;">(buf));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> !!last_hit;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">clr_hit_marker</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* All-hit markers are meaningful only at the very top level</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* OR node.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">hit</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> != GREP_NODE_OR)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">hit</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">chk_hit_marker</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_expr *</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* Top level nodes have hit markers. &#160;See if they all are hits */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> (</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">node</span><span style="color: #d4d4d4;"> != GREP_NODE_OR)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">hit</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">left</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">hit</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = </span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">u</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">right</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/*</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* we do not have to do the two-pass grep when we do not check</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* buffer-wide "all-match".</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">all_match</span><span style="color: #d4d4d4;"> &amp;&amp; !</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no_body_match</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_1</span><span style="color: #d4d4d4;">(opt, gs, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">/* Otherwise the toplevel "or" terms hit a bit differently.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;* We first clear hit markers from them.</span></div>
      <div><span style="color: #6a9955;">&#160; &#160; &#160;*/</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">clr_hit_marker</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">body_hit</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_source_1</span><span style="color: #d4d4d4;">(opt, gs, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">all_match</span><span style="color: #d4d4d4;"> &amp;&amp; !</span><span style="color: #dcdcaa;">chk_hit_marker</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">pattern_expression</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">no_body_match</span><span style="color: #d4d4d4;"> &amp;&amp; </span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">body_hit</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_1</span><span style="color: #d4d4d4;">(opt, gs, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_init_buf</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;"> = GREP_SOURCE_BUF;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = buf;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;"> = size;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_buffer</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_opt *</span><span style="color: #9cdcfe;">opt</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">unsigned</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">long</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source gs;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> r;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_source_init_buf</span><span style="color: #d4d4d4;">(&amp;gs, buf, size);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; r = </span><span style="color: #dcdcaa;">grep_source</span><span style="color: #d4d4d4;">(opt, &amp;gs);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_source_clear</span><span style="color: #d4d4d4;">(&amp;gs);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> r;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_init_file</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;"> = GREP_SOURCE_FILE;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">xstrdup_or_null</span><span style="color: #d4d4d4;">(name);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">xstrdup_or_null</span><span style="color: #d4d4d4;">(path);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">xstrdup</span><span style="color: #d4d4d4;">(path);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_init_oid</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">, </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> object_id *</span><span style="color: #9cdcfe;">oid</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> repository *</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;"> = GREP_SOURCE_OID;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">xstrdup_or_null</span><span style="color: #d4d4d4;">(name);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">xstrdup_or_null</span><span style="color: #d4d4d4;">(path);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">oiddup</span><span style="color: #d4d4d4;">(oid);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;"> = repo;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_clear</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">FREE_AND_NULL</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">FREE_AND_NULL</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">FREE_AND_NULL</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_source_clear_data</span><span style="color: #d4d4d4;">(gs);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_clear_data</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* these types own the buffer */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">((</span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *)gs-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">NULL</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_BUF:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">/* leave user-provided buf intact */</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load_oid</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">enum</span><span style="color: #d4d4d4;"> object_type type;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">repo_read_object_file</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">repo</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;">, &amp;type,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &amp;</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">error</span><span style="color: #d4d4d4;">(</span><span style="color: #dcdcaa;">_</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"'</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">': unable to read </span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">),</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">name</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #dcdcaa;">oid_to_hex</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;">));</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load_file</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *filename = </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">identifier</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> stat st;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">char</span><span style="color: #d4d4d4;"> *data;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">size_t</span><span style="color: #d4d4d4;"> size;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> i;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #dcdcaa;">lstat</span><span style="color: #d4d4d4;">(filename, &amp;st) &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; err_ret:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (errno != ENOENT)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">error_errno</span><span style="color: #d4d4d4;">(</span><span style="color: #dcdcaa;">_</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"failed to stat '</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">'"</span><span style="color: #d4d4d4;">), filename);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">S_ISREG</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">st</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">st_mode</span><span style="color: #d4d4d4;">))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; size = </span><span style="color: #dcdcaa;">xsize_t</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">st</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">st_size</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; i = </span><span style="color: #dcdcaa;">open</span><span style="color: #d4d4d4;">(filename, O_RDONLY);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (i &lt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">goto</span><span style="color: #d4d4d4;"> err_ret;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; data = </span><span style="color: #dcdcaa;">xmallocz</span><span style="color: #d4d4d4;">(size);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">st</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">st_size</span><span style="color: #d4d4d4;"> != </span><span style="color: #dcdcaa;">read_in_full</span><span style="color: #d4d4d4;">(i, data, size)) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">error_errno</span><span style="color: #d4d4d4;">(</span><span style="color: #dcdcaa;">_</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"'</span><span style="color: #9cdcfe;">%s</span><span style="color: #ce9178;">': short read"</span><span style="color: #d4d4d4;">), filename);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">close</span><span style="color: #d4d4d4;">(i);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">free</span><span style="color: #d4d4d4;">(data);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">close</span><span style="color: #d4d4d4;">(i);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> = data;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;"> = size;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">switch</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;">) {</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_FILE:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load_file</span><span style="color: #d4d4d4;">(gs);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_OID:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load_oid</span><span style="color: #d4d4d4;">(gs);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">case</span><span style="color: #d4d4d4;"> GREP_SOURCE_BUF:</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;"> ? </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> : -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; }</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">BUG</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"invalid grep_source type to load"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_load_driver</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> index_state *</span><span style="color: #9cdcfe;">istate</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_attr_lock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">userdiff_find_by_path</span><span style="color: #d4d4d4;">(istate, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">userdiff_find_by_name</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"default"</span><span style="color: #d4d4d4;">);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_attr_unlock</span><span style="color: #d4d4d4;">();</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
      <div><span style="color: #569cd6;">static</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">grep_source_is_binary</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> grep_source *</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">,</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> index_state *</span><span style="color: #9cdcfe;">istate</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">{</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">grep_source_load_driver</span><span style="color: #d4d4d4;">(gs, istate);</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;"> != -</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">driver</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">binary</span><span style="color: #d4d4d4;">;</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (!</span><span style="color: #dcdcaa;">grep_source_load</span><span style="color: #d4d4d4;">(gs))</span></div>
      <div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">buffer_is_binary</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">buf</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">gs</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #9cdcfe;">size</span><span style="color: #d4d4d4;">);</span></div>
      <br>
      <div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">;</span></div>
      <div><span style="color: #d4d4d4;">}</span></div>
      <br>
    </div>
    <!--EndFragment-->
  </body>
</html>
